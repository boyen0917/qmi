<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">

    </style>
    <link rel="stylesheet" type="text/css" href="datepicker/datetimepicker.css" />
   
    <script src="../js/jquery.js"></script>
    <script src="js/jquery.plugin.js"></script>

   </head>
<body>
  <button>click</button>

    <script>
      $(function(){

        $.extend({
          getUrlVars: function(){
            var vars = [], hash;
            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
            for(var i = 0; i < hashes.length; i++)
            {
              hash = hashes[i].split('=');
              vars.push(hash[0]);
              vars[hash[0]] = hash[1];
            }
            return vars;
          },
          getUrlVar: function(name){
            return $.getUrlVars()[name];
          }
        });
      
      // Getting URL var by its nam
      var handler = $.getUrlVar('handler');

        function openDB (name,version) {
            var version=version || 1;
            var request=window.indexedDB.open(name,version);
            request.onerror=function(e){
                console.log(e.currentTarget.error.message);
            };
            request.onsuccess=function(e){
                myDB.db=e.target.result;

                console.debug(myDB.name);
                // var t = db.transaction(['students','teacher']);  //打开一个事务，使用students 和teacher object store
                // var objectStore = t.objectStore('students'); //获取students object store

                //getDataByKey(myDB.db,'students',2);
                // addData(myDB.db,'students');
                // deleteDataByKey(myDB.db,'students',4);
                // getDataByIndex(myDB.db,'students','nameIndex','Byron');

                // fetchStoreByCursor(myDB.db,'students');
                
                //getMultipleData(myDB.db,'students','ageIndex',26);

                console.debug("handler:",handler);
                switch(handler){
                  case 'add':
                      console.debug("add");
                      addData(myDB.db,'students');
                    break;
                  case 'get':
                  console.debug("get");
                      getDataByIndex(myDB.db,'students','nameIndex','Byron');
                    break;
                  case 'put':
                    break;
                  case 'delete':
                  console.debug("delete");
                      deleteDB(myDB.name);
                    break;
                }


                // closeDB(myDB.db);
               //deleteDB(myDB.name);
            };
            request.onupgradeneeded=function(e){
                console.log('DB version changed to '+version);
                myDB.db=e.target.result;

                


                if(!myDB.db.objectStoreNames.contains('students')){
                    console.debug("no data la");
                    var store=myDB.db.createObjectStore('students',{keyPath: 'id'});
                    store.createIndex('nameIndex','name',{unique:true}); 
                    store.createIndex('ageIndex','age',{unique:false}); 
                }

            };
        }

        function closeDB(db){
            db.close();
        }

        function deleteDB(name){
            indexedDB.deleteDatabase(name);
        }

        function addData(db,storeName){
            var transaction=db.transaction(storeName,'readwrite'); 
            var store=transaction.objectStore(storeName); 

            for(var i=0;i<students.length;i++){
                store.add(students[i]);

            }
        }

        function getDataByKey(db,storeName,value){
            var transaction=db.transaction(storeName,'readwrite'); 
            var store=transaction.objectStore(storeName); 
            var request=store.get(value); 
            request.onsuccess=function(e){ 
                var student=e.target.result; 
                console.debug(student); 
            };
        }

        function updateDataByKey(db,storeName,value){
            var transaction=db.transaction(storeName,'readwrite'); 
            var store=transaction.objectStore(storeName); 
            var request=store.get(value); 
            request.onsuccess=function(e){ 
                var student=e.target.result; 
                student.age=35;
                store.put(student); 
            };
        }


        function deleteDataByKey(db,storeName,value){
            var transaction=db.transaction(storeName,'readwrite'); 
            var store=transaction.objectStore(storeName); 
            store.delete(value); 
        }

        function clearObjectStore(db,storeName){
            var transaction=db.transaction(storeName,'readwrite'); 
            var store=transaction.objectStore(storeName); 
            store.clear();
        }

        function getDataByIndex(db,storeName,index_name,value){
            var transaction=db.transaction(storeName);
            var store=transaction.objectStore(storeName);
            var index = store.index(index_name);
            index.get(value).onsuccess=function(e){
                var student=e.target.result;
                console.log(student.id);
            }
        }

        function fetchStoreByCursor(db,storeName){
            var transaction=db.transaction(storeName);
            var store=transaction.objectStore(storeName);
            var request=store.openCursor();
            request.onsuccess=function(e){
                var cursor=e.target.result;
                if(cursor){
                    console.log(cursor.key);
                    var currentStudent=cursor.value;
                    console.log(currentStudent.name);
                    cursor.continue();
                }
            };
        }

        function getMultipleData(db,storeName,index_name,value){
            var transaction=db.transaction(storeName);
            var store=transaction.objectStore(storeName);
            var index = store.index(index_name);
            var request=index.openCursor(IDBKeyRange.only(value));
            var request=index.openCursor(IDBKeyRange.bound('B','F',false,true));
            request.onsuccess=function(e){
                var cursor=e.target.result;
                if(cursor){
                    var student=cursor.value;
                    console.log(student);
                    cursor.continue();
                }
            }
        }

        function deleteObjectStore(db,storeName){
          if(db.objectStoreNames.contains(storeName)){ 
              db.deleteObjectStore(storeName); 
          }
        }

        // openDB(myDB.name,myDB.version);
        // setTimeout(function(){
        //     addData(myDB.db,'students');
        // },1000);

        var myDB={
            name:'test',
            version:1,
            db:null
        };

        var students=[{ 
            id:1001, 
            name:"Byron", 
            age:24 
        },{ 
            id:1002, 
            name:"Frank", 
            age:30 
        },{ 
            id:1003, 
            name:"Aaron", 
            age:26 
        }];

        // indexedDB.deleteDatabase(myDB.name);
        openDB(myDB.name,myDB.version);
        // deleteDB("test");





      });


    </script>
</body>
</html>