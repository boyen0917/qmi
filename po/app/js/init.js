// version 2.4.0.2
var ui;
var at;
var gi;
var countrycode = "+886";	//ÂúãÁ¢º
var lang = "en_US";			//Ë™ûË®Ä
var debug_flag = false;		//localÊ∏¨Ë©¶ È†êË®≠ÈñãÂïüconsole
var clearChatTimer;
var default_url = "https://ap.qmi.emome.net/";
var back_exception = false;	//ÈÉ®ÂàÜË∑≥È†Å‰∏çÈúÄË¶ÅË®òÈåÑ

var userLang = navigator.language || navigator.userLanguage;
userLang = userLang.replace(/-/g,"_").toLowerCase();

if( 0 == userLang.indexOf("zh") ) {
	if( userLang=="zh_cn" ) lang = "zh_CN";
	else lang = "zh_TW";	
}

var base_url = function() {
	switch(true) {
		case match("qawp.qmi.emome.net"):
			return "https://qaap.qmi.emome.net/";
		case match("qmi17.mitake.com.tw"):
			return "https://qmi17.mitake.com.tw/";
		default:
			return "https://ap.qmi.emome.net/";
	}
	function match(domain) {
		var regDomain = new RegExp("^https:\/\/"+ domain, 'g');
		return !!window.location.href.match(regDomain);
	}
}();

// var base_url = "https://qmi17.mitake.com.tw/";

if($.lStorage("_selectedServerUrl"))
	base_url = $.lStorage("_selectedServerUrl");

// ÂÖàÊ™¢Êü•ÊòØÂê¶ÁÇ∫Ê°åÊ©üÁâà
var nwGui = function() {
	try {
		return require('nw.gui');
	} catch(e) {
		console.error("ÈùûÊ°åÊ©üÁâà");
		return null;
	};
}();
	
window.QmiGlobal = {

	// ÈÄôÊòØwebÁâàËôü Âè¶ÊúâÊ°åÊ©üÁâàËôü module.js deskTopVersion
	// Â§öÂä†‰∏ÄÂÄãÊ¢ù‰ª∂: Ëã•Ê°åÊ©üÁâàËôüÂ§ßÊñºwebÁâàËôü ‰ª•Ê°åÊ©üÁâàËôüÁÇ∫‰∏ª
	// initReadyË£°Èù¢ÂÅöË™øÊï¥ 
	appVer: "2.4.0.2",

	title: "Qmi",

	// Ê™¢Êü•ÊòØÂê¶ÁÇ∫ËÅäÂ§©ÂÆ§
	isChatRoom: false, // ÁôΩÁÆ±‰∏çÂèØ‰ΩøÁî®Á∂≤ÂùÄÂà§Êñ∑ ÊîπÁÇ∫chat.jsÊåáÂÆö Ê≥®ÊÑèÊôÇÈñìÂ∑Æ

	// Ê°åÊ©üÁâàË®≠ÂÆö
	nwGui: nwGui,

	// appÁöÑË≥áÊñôÁöÑÈ†êË®≠ÂÄº
	defaultAppQmiData: {
		listenerMap: {
			onFocus: function() {
				QmiGlobal.module.appVersion.init()
			}
		}
	},

	appLangDef: $.Deferred(),

	// Âú®‰∏ãÊñπ document ready‰πãÂæå initReady
	initReady: function() {
		var initDefArr = [
    		updateLanguage()
		];

		$.when.apply($, initDefArr).done(function() {
			QmiGlobal.appLangDef.resolve();
			// Ë®≠ÂÆöÈ¶ñÈ†ÅÁâàËôüÈ°ØÁ§∫
			setVersion();

			// nwjsÁöÑËÆäÊï∏
			QmiGlobal.getAppWin().qmiData = QmiGlobal.getAppWin().qmiData || QmiGlobal.defaultAppQmiData;
			setAppOnFocusEvent(true);

			// ËÉåÊôØÂü∑Ë°åÔºåÈªûÂèñÊ°åÈù¢ÊáâÁî®Á®ãÂºèiconÈ°ØÁ§∫Ë¶ñÁ™ó
			try {
				nwGui.App.on('open', function () {
					QmiGlobal.getAppWin().show();
				});
			} catch(e) {}
			
			// ÂØ´ÂÖ•ÁâàÊú¨Ëôü
			$("#app-version").attr("ver-chk", $.i18n.getString("WEBONLY_VERSION_CHK"));
			$("#app-version").attr("version", QmiGlobal.appVer);

			// ÂàùÂßãÂãï‰Ωú registration
			appInitial();
		});

		function setAppOnFocusEvent(isExec) {
			try {
				QmiGlobal.getAppWin().removeListener("focus", QmiGlobal.getAppWin().qmiData.listenerMap.onFocus);
				QmiGlobal.getAppWin().qmiData.listenerMap.onFocus = QmiGlobal.defaultAppQmiData.listenerMap.onFocus;
				QmiGlobal.getAppWin().on("focus", QmiGlobal.getAppWin().qmiData.listenerMap.onFocus);

				if(isExec) QmiGlobal.module.appVersion.init();
			} catch(e) {errorReport(e)}
		}

		function setVersion() {
			// ÁôªÂÖ•È†ÅÈ°ØÁ§∫Ê°åÊ©üÁâàËôü
			$("#container_version").text("Webkit: "+QmiGlobal.nwVer +"("+ QmiGlobal.appVer + ")");

			// ‰∏çÁ≠âÊñº1 Ë°®Á§∫Ê°åÊ©üÁâàËôüÊ≤íÊúâÂ§ßÊñºwebÁâàËôü ‰∏çÂÅö‰∫ã
			// if(QmiGlobal.module.appVersion.compare(QmiGlobal.nwVer, QmiGlobal.appVer) !== 1) return;

			// Ê°åÊ©üÁâàËôü ÊåáÂÆöÁµ¶ webÁâàËôü
			// QmiGlobal.appVer = QmiGlobal.nwVer;
		}
	},


	nodeModules: function() {
		if(!nwGui) return {};

		return {
			childProcess: req("child_process"),
			fs: req("fs"),
			path: req("path"),

			https: req("https"),

			ffmpeg: req("fluent-ffmpeg"),
    		
			notifier: req("node-notifier"),
		};

		function req(moduleName) {
			try {
				return require(moduleName)
			} catch(e) {
				console.error("require exception:", e);
				return {};
			}
		}
	}(),

	getAppWin: function() {
		if(QmiGlobal.nwGui === null) return {};
		return QmiGlobal.nwGui.Window.get();
	},


	nwVer: function() {
		try {
			return require("nw.gui").App.manifest.version;
		} catch(e) {return "web"}
	}(),

	// ‰πãÂæåÂèñ‰ª£ ui, at, gi, ... etc
	currentGi: "",

	device: navigator.userAgent.substring(navigator.userAgent.indexOf("(")+1,navigator.userAgent.indexOf(")")) || navigator.userAgent,

	groups: {}, // ÂÖ®ÈÉ®ÁöÑÂÖ¨ÁßÅÈõ≤ÂúòÈ´îË≥áÊñô QmiGlobal.groups
	companies: {}, // ÂÖ®ÈÉ®ÁöÑcompanyË≥áÊñô
	companyGiMap: {},
	cloudCompanyMap: {}, // ldapÈõ≤Ë≥áË®ä
	ldapCompanies: {}, // ldapÈõ≤Ë≥áË®ä
	windowListCiMap: {},
	module: {}, // Ê®°ÁµÑ
	method: {}, // ÂÖ¨Áî®ÂáΩÊï∏
	rspCode401: false,

	vdoCompressBasePct: 80, // Â£ìÁ∏ÆÈ†êË®≠ÈÄ≤Â∫¶Ê¢ùÊØî‰æã

	sepSign: "üóø", //ÊêúÂ∞ãÂ≠óÂÖ∏ÁöÑËá™Ë®ÇÂàÜÈöîËôü

	// ÂúñÁâáÂ£ìÁ∏Æ
	imgCompress: {
		oR: 0.9,
		tR: 0.2,
		oH: 1280,
		oW: 1280,
		tH: 1280,
		tW: 1280
	},

	ajaxExpireTimer: 1 * 86400 * 1000, // ms, ‰∏ÄÂ§©
	ldapExpireTimer: 1 * 86400 * 1000, // ms, ‰∏ÄÂ§©

	isGetAllCloudPolling: true, // Á¨¨‰∏ÄÊ¨°pollingË¶ÅÊâìÊâÄÊúâÁßÅÈõ≤
	reDoCompanyPollingMap: {}, // ÈúÄË¶ÅÈáçÊâìÁöÑÁßÅÈõ≤pollingË≥áË®ä {ci:xx, pt:xx}, ...

	auth: {},
	me: {},

	emptyGrpPicStr: "images/common/others/empty_img_all_l.png",
	emptyUsrPicStr: "images/common/others/empty_img_personal_l.png",

	resetDBExceptionArr: [
		"_ver",
		"_appReloadAuth",
		"_lastLoginAccount",
		"_loginAutoChk",
		"_loginData",
		"_loginRemember",
		"_sticker",
		"_selectedServerUrl",
		"groupChat"
	],

	viewMap: {}, // cloud reload

	authCode: function() {
		var rspCode, level = 1;
		return {
			set: function(code) {
				rspCode = code;
			},
			get: function(code) {
				return rspCode;
			},
			setLevel: function(lv) {
				level = lv;
			},
			getLevel: function() {
				return level;
			}
		}
	}(),

	ajaxLoadingUI: {
		show: function() {
			$('.ui-loader').show();
			$(".ajax-screen-lock").show();
		},
		hide: function() {
			$('.ui-loader').hide();
			$(".ajax-screen-lock").hide();
		}
	},

	isCompanyLoaded: function(thisCi) {
		var chkArr = Object.keys(QmiGlobal.companyGiMap).reduce(function(arr, currGi) {
			if(QmiGlobal.companyGiMap[currGi].ci === thisCi) arr.push(currGi)
			return arr;
		}, []);

		return !!chkArr.length;
	},

	getActivedUserNum: function(thisGi) {
		if(!QmiGlobal.groups[thisGi]) return 0;
		return Object.keys((QmiGlobal.groups[thisGi].guAll || {})).reduce(function(total, currGi) {
			if(QmiGlobal.groups[thisGi].guAll[currGi].st === 1) total++;
			return total;
		}, 0);
	},

	chainDeferred: function(firstDef) {
		var thenDefArr = [firstDef];
		return {
			then: function(argFun) {
				var thisDeferred = $.Deferred();
				var currDefIndex = thenDefArr.length;
				var lastDefIndex = currDefIndex - 1;
				thenDefArr[currDefIndex] = thisDeferred;
				$.when(thenDefArr[lastDefIndex]).done(function(rspData) {
					if(!argFun instanceof Function) return;
					var argFunResult = argFun(rspData);
					if(argFunResult instanceof Object) 
						(argFunResult.done || function() {})(thisDeferred.resolve);
				});
				return this;
			}
		}
	},

	isDefResolved: function(def) {
        if(!def) return true;
        if(!def.state instanceof Function) return true;
        if(def.state() !== "pending") return true;
        return false;
    },
	
	appReload: function() {
	    var flag = false;
	    var periodTime = 8 * 60 * 60 * 1000; // ÊØè8Â∞èÊôÇreload‰∏ÄÊ¨°
	    // Ë®àÁÆóÈáçÊñ∞ËÆÄÂèñÈ†ÅÈù¢ÁöÑÊôÇÈñì
	    if($.lStorage("_periodicallyReloadTimer") === false) setTimer();

	    return {
	        chk: function() {
	        	if($.lStorage("_periodicallyReloadTimer") === false) setTimer();
	            if(new Date().getTime() - $.lStorage("_periodicallyReloadTimer") > periodTime) {
	                flag = true;
	            }
	        },

	        do: function(argsObj) {
	            if(!argsObj) return;
	            if(!QmiGlobal.auth.at) {
	            	location.reload();
	            	return;
	            }

	            if(flag === false && !argsObj.isReloadDirectly) return;

	            var wl = {};
	            $.each(windowList,function(key,value){try {
	                if(value.closed) return;
	                if(!wl[value.gi]) return;
	                (wl[value.gi] || {})[key] = QmiGlobal.groups[value.gi].chatAll[value.ci];
	            } catch(e) {}});

	            // Ë®≠ÂÆöÁï∂Ââçgi
	            QmiGlobal.auth.appReloadObj = {
	                gi: QmiGlobal.currentGi,
	                param: argsObj
	            };

	            $.lStorage("groupChat", wl);
	            $.lStorage("_appReloadAuth", QmiGlobal.auth);
	            setTimer();
	            
	            // location.reload();
	            clearCache();
	        }
	    };

	    function setTimer(){
	        $.lStorage("_periodicallyReloadTimer", new Date().getTime());
	    }
	}(),

	getLinkStateDef: function(link) {
        var deferred = $.Deferred();
        var ajx = $.ajax(link).fail(function() {
            deferred.resolve(false);
        }).done(function() {
            deferred.resolve(true);
        })

        setTimeout(function() {
            if(deferred.state() === "resolved") return;
            deferred.resolve(true);
            ajx.abort();
        }, 1000);

        return deferred.promise();
    },


	makeErrCodeStr: function(errNum) {
		return "<div class=\"popup-errCode\">"+ $.i18n.getString("WEBONLY_POPUP_ERRCODE") +" : " + errNum +"</div>";
	}
};

$(document).ready(QmiGlobal.initReady);


// pollingÁï∞Â∏∏Áõ£Êéß
window.QmiPollingChk = {

	flag: false, // ËÅäÂ§©ÂÆ§‰∏çÈñãÂïì

	cnt: 0, // Ë°®Á§∫ÊúâÂú®Êõ¥Êñ∞

	// 5ÂàÜÈêòÊ™¢Êü•‰∏ÄÊ¨°pollingÊ≠ª‰∫ÜÊ≤í
	interval: setInterval(function() {
		//  ËÅäÂ§©ÂÆ§‰∏çÈñãÂïì
		if(window.QmiPollingChk.flag === false) return;

		var oriNum = window.QmiPollingChk.cnt;

		// Ê™¢Êü• 100ÁßíÂÖßÁöÑcntÊúâÊ≤íÊúâÁï∞Â∏∏Â¢ûÂä†
		setTimeout(function(){
			var diff = window.QmiPollingChk.cnt - oriNum;

			// Âö¥Ê†º‰æÜË™™ Ë∂ÖÈÅé25Ê¨°Â∞±‰∏çÊ≠£Â∏∏ 30ÁßíÂæåÈáçÂïüpolling
			// Ê≤íÂ¢ûÂä†Ë°®Á§∫ÂÅú‰∫Ü ‰πüÈáçÂïü
			if(diff > 25 || diff === 0) {
				console.log("pollingÁï∞Â∏∏ 30ÁßíÂæåÈáçÂïü");

				QmiGlobal.pollingOff = true;
				setTimeout(function(){
					console.log("30Áßí ÈáçÂïü");
					QmiGlobal.pollingOff = false;
					polling();
				}, 30000);
			}
		}, 100000);
	}, 300000)
};


//timelineË£èÈù¢ÈªûÊìä‰∏çÂÅöÂ±ïÈñãÊî∂ÂêàÁöÑÂçÄÂüü
var timeline_detail_exception = [
	".st-sub-box-2-content-detail a",
	".st-sub-box-2-more-desc-detail a",
	".st-box2-more-task-area-detail",
	".audio-play",
	".st-sub-box-more-btn",
	".st-more-close",
	".st-user-pic",
	".st-sub-box-more",
	".st-sub-box-2-attach-area"
];

//timelineÂÖßÂÆπ Âà§Êñ∑‰∏çÈñãÂïìÈôÑÊ™îÂçÄÂüüÁöÑtype ;1ÊòØÁ∂≤ÂùÄ ‰ΩÜË¶ÅÂè¶Â§ñÂà§Êñ∑
var not_attach_type_arr = [0,1,12,13,14,15];
	
var load_show = false;		//È°ØÁ§∫loading ÂúñÁ§∫ ÁöÑÂèÉÊï∏
var s_load_show = false;	//ÁâπÂà•ÁöÑ
var compose_timer = false;	//Áôº‰ΩàË®àÊôÇÂô®
var max_w = 500; 			//Á∏ÆÂúñÂØ¨È´ò
var max_h = 500;			//Á∏ÆÂúñÂØ¨È´ò
var quality = 0.5;			//Á∏ÆÂúñÂØ¨È´ò

//Ë®≠ÁΩÆËÅäÂ§©Ë®äÊÅØÈ†êË¶Ω
var set_notification = $.lStorage("_setnoti") || true;

//timelineÁΩÆÈ†Çmillisecond
var top_timer_ms = $.lStorage("_topTimeMs") || 5000;

var polling_interval = 5000;			//pollingÈñìË∑ù


//tabÂ∞çÁÖßË°®
var initTabMap = {
	0: {
		act: "feed-public",
		textId: "LEFT_FEED_GROUP"
	}, 1: {
		act: "feed-post",
		textId: "LEFT_FEED_MEMBER"
	}, 2: {
		act: "feeds",
		textId: "LEFT_FEED",
		class: ["polling-cnt","polling-local"],
		pollingType: "A1"
	}, 3: {
		act: "chat",
		textId: "LEFT_CHAT",
		class: ["polling-cnt","polling-local"],
		pollingType: "A3"
	}, 6: {
		act: "memberslist",
		textId: "LEFT_MEMBER",
		class: ["polling-cnt","polling-local"],
		pollingType: "A2"
	}, 7: {
		act: "groupSetting",
		textId: "GROUPSETTING_TITLE"
	}, 9: {
		act: "addressBook",
		textId: "ADDRESSBOOK_TITLE"
	}, 10 :{
		act: "fileSharing",
		textId: "FILESHARING_TITLE"
	}, 11 :{
		act: "webview",
		textId: "WEBVIEW",
		pollingType: "A6"
	}
};

//penÂ∞çÁÖßË°®
var initPenMap = {
	0:{
		fcBox: "announcement",
		textId: "FEED_BULLETIN",
		imgNm: "bulletin"
	},
	1:{
		fcBox: "feedback",
		textId: "FEED_REPORT",
		imgNm: "report"
	},
	2:{
		fcBox: "work",
		textId: "FEED_TASK",
		imgNm: "task"
	},
	3:{
		fcBox: "vote",
		textId: "FEED_VOTE",
		imgNm: "vote"
	},
	4:{
		fcBox: "check",
		textId: "FEED_LOCATION",
		imgNm: "location"
	},
	5:{
		fcBox: "post",
		textId: "FEED_POST",
		imgNm: "post"
	}
};

String.prototype._escape = function(){
    return this.replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

String.prototype.qmiTag = function (tagMember) {
	var findText = "///;" + tagMember.u + ";///";
	var markTag = "<b name='" + tagMember.u + "'>" + tagMember.n + "</b>";
	return this.replace("///;" + tagMember.u + ";///", "<b name='" + tagMember.u + "'>" + tagMember.n + "</b>");
}

Number.prototype.toFileSize = function () {
	var unitIndex = Math.floor( Math.log(this) / Math.log(1024) );
    return (this / Math.pow(1024, unitIndex)).toFixed(2) + ' ' 
    	+ ['B', 'kB', 'MB', 'GB', 'TB'][unitIndex];
}


//‰∏ä‰∏ÄÈ†Å È†êË®≠
$(document).data("page-history",[["",""]]);

//ÁôªÂÖ•ÊôÇÈñì
if( window.parent && window.parent.login_time )
	login_time = window.parent.login_time;
else
	login_time = new Date().getTime();



window.QmiAjax = function(args){
	// body and method
	var self = this;

	// apiÁâàÊú¨ È†êË®≠apiv1
	self.apiVer = args.apiVer || "apiv1";

	var	ajaxDeferred = $.Deferred(),

		// Âà§Êñ∑ÁßÅÈõ≤api
		companyData = (function(){

			// ÊúâÊåáÂÆöurl Âä†‰∏ä‰∏çË¶ÅÁßÅÈõ≤ ÊúÄÂÑ™ÂÖà ex: ÂÖ¨Èõ≤polling
			if(args.isPublicApi === true)
				return undefined;

			// ÊúâÊåáÂÆöci Áõ¥Êé•Áµ¶‰ªñÁßÅÈõ≤
			if(args.ci !== undefined)
				return QmiGlobal.companies[args.ci];

			// Âà§Êñ∑apiNameÊúâÁÑ°ÂåÖÂê´ÁßÅÈõ≤gi ÊúâÁöÑË©±Â∞±Áµ¶‰ªñÁßÅÈõ≤
			if(args.apiName !== undefined){
				// ÊéíÈô§ÊúâÁ∂≤ÂùÄÊúâÔºüÁöÑÁãÄÊ≥Å
				var apiGi = args.apiName.split("?")[0].split("/").find(function(item){
					return QmiGlobal.groups.hasOwnProperty(item)
				});

				// api ÂåÖÂê´ group id ËÄå‰∏î Âú®ÁßÅÈõ≤ÂÖß ÂõûÂÇ≥ÁßÅÈõ≤ Âê¶ÂâáÂõûÂÇ≥undefined ‰∏çÂæÄ‰∏ãÂÅö
				if(apiGi !== undefined)
					return QmiGlobal.companyGiMap.hasOwnProperty(apiGi) ? QmiGlobal.companies[ QmiGlobal.companyGiMap[apiGi].ci ] : undefined;
			}

			// ÊúÄÂæåÂà§Êñ∑ ÁèæÂú®ÂúòÈ´îÊòØÁßÅÈõ≤ÂúòÈ´î Â∞±ÂÅöÁßÅÈõ≤
			if(QmiGlobal.companyGiMap[gi] !== undefined)
				return QmiGlobal.companies[ QmiGlobal.companyGiMap[gi].ci ];

		}()),

		newArgs = {
			url: (function(){
				// ÊåáÂÆöurl
				if(args.url) return args.url;

				// undefined Ë°®Á§∫ ‰∏çÁ¨¶ÂêàÁßÅÈõ≤Ê¢ù‰ª∂ Áµ¶ÂÖ¨Èõ≤
				if(companyData)
					return "https://" + companyData.cl +"/"+ self.apiVer +"/"+ args.apiName;
				else
					return base_url + self.apiVer +"/"+ args.apiName;
			}()),
			// setHeaders: outerArgs,companyData
			headers: self.setHeaders(args, companyData),

			// timeout: 30000,

			type: (args.method  || args.type) || "get"
		};
	// end of var

	// Âà§Êñ∑companyData ctp === 0 Ë¶ÅÊõøÊèõÂÖ¨Èõ≤atÁµ¶‰ªñ
	if((companyData || {}).ctp === 0) {
		companyData.nowAt = QmiGlobal.auth.at;
		companyData.et = 9999999999999;
	}

	// ‰∏çÊòØget ÂÜçÂä†ÂÖ•body
	if(newArgs.type !== "get") newArgs.data = (typeof args.body === "string") ? args.body : JSON.stringify(args.body);

	// Â∞áargsÂ∏∂‰æÜÁöÑÂ§öÁöÑÂèÉÊï∏Ë£úÈÄ≤ÂéªnewArgs
	Object.keys(args).forEach(function(argsKey){
		if(newArgs.hasOwnProperty(argsKey) === false)
			newArgs[argsKey] = args[argsKey];
	});


	//before send ; SSO ‰∏çÈñãÂïüloader ui
	if((args.isLoadingShow === true || s_load_show === true)
		&& args.isSso !== true
	) {
		$(".ajax-screen-lock").show();
		$('.ui-loader').css("display","block");
	}


	// ÂêÑÂÄãÁßÅÈõ≤ÈÉΩÊúâÂêÑËá™reAuthDeferred
	var reAuthDeferred = (companyData || {}).reAuthDef;
	
	// Âü∑Ë°åÂâç ÂÖàÁúãreAuth lockÊ≤í  Ëã•ÊòØSSO reAuth Â∞±Áõ¥Êé•Âü∑Ë°å
	if(args.isSsoReAuth === true) ajaxExecute({isSuccess: true})
	else $.when(reAuthDeferred).done(function(){
		self.expireChk({
			url: newArgs.url,
			noAuth: args.noAuth,
			companyData: companyData,
			isPolling: args.isPolling
		}).done(ajaxExecute)
	})

	function ajaxExecute(chk) {
		// ÁôºÁîüÈåØË™§
		if(chk.isSuccess === false) {
			// setTimeoutÊòØËÆì ajaxDeferred.promise.success„ÄÅerror ÂÖàËß∏Áôº
			setTimeout(function() {
				ajaxDeferred.reject({
					status: 9999,
					isSuccess: false,
					data: chk.data,
					isCancel: chk.isCancel
				});
			}, 100);
			return;
		}

		// ÊúâÁ∂ìÈÅéreAuth Êõ¥Êñ∞headers
		// setHeaders: outerArgs,companyData
		newArgs.headers = self.setHeaders(args, companyData);

		// 5392 Âä†ÂÖ•ÁâàËôü
		newArgs.headers.av = QmiGlobal.appVer;

		// Âü∑Ë°å
		$.ajax(newArgs).complete(function(rspData){
			// deferred chain -> ÈÄôÈÇäÂèØ‰ª•ÁúÅÁï• ‰πüÂèØÁ≤æÁ∞° ‰πãÂæåÂÅö Áî®‰∏ÄÂÄãdeferredÂÅöreauthË∑üÈáçÊñ∞Âü∑Ë°åajax
			// 1. Âà§Êñ∑ÊòØÂê¶reAuth
			// 2. reAuth‰πãÂæåÈáçÂÅöÂéüÊú¨ÁöÑajax
			// 3. ÂõûÂà∞ÂéüÊú¨ajaxÁöÑÂà§Êñ∑

			if(QmiGlobal.authCode.get()) {
				rspData.status = 401;
				rspData.responseText = JSON.stringify({
					rsp_code: QmiGlobal.authCode.get()
				})
			}

			(function(){
				var reAuthDefChain = MyDeferred();
				// reAuth: tokenÈÅéÊúü
				if( rspData.status === 401
					&& args.noAuth !== true
				) {
					// Âü∑Ë°åÂâç ÂÖàÁúãreAuth lockÊ≤í
					$.when(reAuthDeferred).done(function(){
						self.reAuth(companyData, rspData).done(reAuthDefChain.resolve);
					});
				} else {
					reAuthDefChain.resolve({
						isReAuth: false,
						isSuccess: true,
						data: rspData
					});
				}
				return reAuthDefChain;
			})().then(function(resultObj){
				// 2. reAuth‰πãÂæåÈáçÂÅöÂéüÊú¨ÁöÑajax
				var reAuthDefChain = MyDeferred();
				if(resultObj.isReAuth === false) {
					// ‰∏çÁî®reAuth Áõ¥Êé•ÈÄ≤Ë°å
					reAuthDefChain.resolve(resultObj);
				} else if(resultObj.isSuccess === true){
					// ÈáçÊñ∞ÂèñÂæótokenÊàêÂäü ÊèõÊéâatÂæå ÈáçÊñ∞ÂÅöajax
					// setHeaders: outerArgs,companyData
					newArgs.headers = self.setHeaders(args, companyData);

					$.ajax(newArgs).complete(function(newData){
						reAuthDefChain.resolve({
							isSuccess: true,
							data: newData
						});
					})
				} else {
					// auth ÂÜçÂ∫¶ÁôºÁîüÈåØË™§ Â∞±ÂÇ≥ÂÖ•self.reAuthÁöÑÈåØË™§ÂÖßÂÆπ
					reAuthDefChain.resolve(resultObj);
					// auth ÂÜçÂ∫¶ÁôºÁîüÈåØË™§ ÈóúÈñâcompanyÊâÄÂ±¨ÂúòÈ´îÁöÑui
					if(companyData) QmiGlobal.module.reAuthUILock.lock(companyData);
				}

				return reAuthDefChain;
			}).then(function(reAuthObj){
				// 3. ÂÅöÂéüÊú¨ajaxÁöÑÂà§Êñ∑
				var completeData = reAuthObj.data;
				completeData.ajaxArgs = newArgs;

				// reAuthÂ§±Êïó Êàñ ajax Â§±Êïó
				if(reAuthObj.isSuccess === false || completeData.status !== 200) {
					// ÂõûÂÇ≥Â§±Êïó
					ajaxDeferred.reject(completeData);
					return;
				}

				ajaxDeferred.resolve(completeData);
			}) // end of reAuthDef
		})// end of ajax
	}

	var completeCB,successCB,errorCB;

	// ÂÖàÊêúÈõÜÂ•Ωcallback Â¶ÇÊûúÊúâÂëºÂè´ deferredÂÆåÊàêÂæåÂ∞±Âü∑Ë°å
	ajaxDeferred.promise().complete = function(cb) {
		completeCB = cb;
		return ajaxDeferred.promise();
	};

    ajaxDeferred.promise().success = function(cb) {
        successCB = cb;
        return ajaxDeferred.promise();
    };

	ajaxDeferred.promise().error = function(cb) {
		errorCB = cb;
		return ajaxDeferred.promise();
	};

	// complete‰æÜÈÄôË£°
	ajaxDeferred.always(function(completeData){
		self.onComplete(completeData);
		if(completeCB instanceof Function) completeCB(completeData);
	});

	// success ‰æÜÈÄôË£°
	ajaxDeferred.done(function(completeData){
        if(successCB instanceof Function) {
        	try {
        		var responseObj = JSON.parse(completeData.responseText);
        		responseObj.newArgs = newArgs;
        		successCB(responseObj);
        	} catch(e) {
        		console.log("ajax done catch error", e);
        		if(errorCB instanceof Function) {
        			completeData.errMsg = "parse error";
        			errorCB(completeData);
        		}
        		return;
        	}
        }
    })

	ajaxDeferred.fail(function(completeData) {

		completeData.newArgs = newArgs;

		self.onError(completeData);
		if(errorCB instanceof Function) errorCB(completeData);
	});


	return ajaxDeferred.promise();
}

QmiAjax.prototype = {

	authLock: (function(){
		var isLock = false;
		var intervalTimer;

		//ÂÆâÂÖ®Ê©üÂà∂ 3ÁßíÂæåÊîπÂõûfalse ÈÅøÂÖçreAuthË£°ÁöÑintervalÁÑ°ÈôêÊâì
		function unlock(){
			clearInterval(intervalTimer);
			intervalTimer = setInterval(function(){
				isLock = false;
				clearInterval(intervalTimer);
			},3000);
		}

		return {
			set: function(status){
				isLock = status;
				unlock();
			},
			chk: function() {
				return isLock;
			}
		}
	})(),

	// ÂàùÂßãË®≠ÂÆö ‰ª•Âèä reAuth ÊúÉÁî®Âà∞
	setHeaders: function(outerArgs,companyData){
		// ÊåáÂÆöheaders
		if(outerArgs.specifiedHeaders !== undefined) return outerArgs.specifiedHeaders;

		var newHeaders = {};

		// ÂÖà extend Â§ñÈÉ®ÂèÉÊï∏ÂÄº
		if(outerArgs.headers !== undefined) {
			$.extend(newHeaders, outerArgs.headers);
		}

		// È†êË®≠ÂÖ¨Èõ≤ui,at
		newHeaders.ui = QmiGlobal.auth.ui;
		newHeaders.at = QmiGlobal.auth.at;
		newHeaders.li = lang;

		// ÂÅöÁßÅÈõ≤Âà§Êñ∑
		if(companyData !== undefined) {
			newHeaders.uui = newHeaders.ui;
			newHeaders.uat = newHeaders.at;
			newHeaders.ui = companyData.ui;
			newHeaders.at = companyData !== QmiGlobal.auth ? companyData.nowAt : companyData.at;
		}

		return newHeaders;
	},

	expireChk: function(args) {
		// ÈáçÊñ∞ÂèñÂæóÁßÅÈõ≤
		args.companyData = QmiGlobal.companies[(args.companyData || {}).ci];

		// Âü∑Ë°åÂâç ÂÖàÊ™¢Êü•ÊòØÂê¶Êé•ËøëÈÅéÊúüÊôÇÈñì ÂÖàÊõøÊèõtoken
		var nowEt = (args.companyData === undefined) ? QmiGlobal.auth.et : args.companyData.et;
		var deferred = $.Deferred();

		if(args.noAuth === true) {
			// ‰∏çÁî®auth
			deferred.resolve({isSuccess: true});

		} else if(isExpired()) {
			console.log("token Expire!!!");

			if(isPollingAndLdapCanceled()) 
				deferred.resolve({
					isSuccess: false,
					isCancel: true
				})
			else 
				this.reAuth(args.companyData).done(deferred.resolve);

		} else {
			// ÈÇÑÊ≤íÈÅéÊúü
			deferred.resolve({isSuccess: true});
		}
		return deferred.promise();

			

		function isExpired() {
			var currTime = new Date().getTime();
			// tp1 ÊòØÈúÄË¶ÅËº∏ÂÖ•ÂØÜÁ¢ºÁöÑÁßÅÈõ≤ expireÊôÇÈñìÁõ¥Êé•Â∞±ÊòØÁßÅÈõ≤Êèê‰æõÁöÑÊôÇÈñì et
			if(isLdapCompanyOrSSOLogin()) return (nowEt - currTime) < QmiGlobal.ldapExpireTimer;
			// ÈÅéÊúüÊ™¢Êü• ÊèêÂâçÂπæÂ§©Ê™¢Êü•
			else return (nowEt - currTime) < QmiGlobal.ajaxExpireTimer;

			function isLdapCompanyOrSSOLogin() {
				// ldap company
				if((args.companyData || {}).passwordTp === 1) return true;
				if(QmiGlobal.auth.isSso)  return true;
				return false; 
			} 
		}

		function isPollingAndLdapCanceled() {
			if(!args.companyData) return false;
			if(!args.isPolling) return false;
			if(args.companyData.isReAuthCancel) return true;
			return false;
		}
	},

	reAuth: function(companyData, rspData){
		var self = this;
		var deferred = $.Deferred();
		companyData = companyData || QmiGlobal.auth;

		// reAuth Lock Â¶ÇÊûúÂ∑≤Á∂ìÊòØdeferred Â∞±‰∏çÈáçÊñ∞ÊåáÂÆö
		if(QmiGlobal.isDefResolved(companyData.reAuthDef)) 
        	companyData.reAuthDef = $.Deferred();

		// Â¶ÇÊûúÊúâÂ∏∂rspData Ë°®Á§∫etÊ≤íÈÅéÊúü Êâì‰∫ÜapiÂçªÂõûÂÇ≥401
		self.doAuth(companyData, rspData).done(deferred.resolve);

		// reAuthÁµêÊùü
		deferred.done(companyData.reAuthDef.resolve)
		return deferred.promise();
	},

	doAuth: function(companyData, rspData) {
		var self = this;
		var deferred = $.Deferred();

		var rspObj = function() {
			try {
				if(rspData)
					return JSON.parse(rspData.responseText);
				else
					return {rsp_code: 9999};
			} catch(e) {
				return {rsp_code: 999, rsp_msg: "parse error"};
			}
		}();

		var rspCode = rspObj.rsp_code;

		// 601: ÂÖ¨Èõ≤TokenÈÅéÊúü, ‰ΩøÁî®Put /authÈÄ≤Ë°åÈáçÊñ∞È©óË≠âÂèñÁöÑÊñ∞ÁöÑToken, Â¶ÇÊûúÈ©óË≠âÂ§±ÊïóÂâáË´ãÈáçÊñ∞ÁôªÂÖ• 
		// 602: ÂÖ¨Èõ≤TokenÈåØË™§, Ê†πÊìö‰πãÂâçÁöÑÊµÅÁ®ã, Â∞áÂº∑Âà∂ÁôªÂÖ•app
		// 603: ÁßÅÈõ≤TokenÈÅéÊúü, ‰ΩøÁî®Put /authÈÄ≤Ë°åÈáçÊñ∞È©óË≠âÂèñÁöÑÊñ∞ÁöÑToken, Â¶ÇÊûúÈ©óË≠âÂ§±ÊïóÂâáË´ãÈáçÊñ∞ÊãâÂèñ/groupsÂèñÁöÑÊñ∞ÁöÑkeyÈÄ≤Ë°åÁßÅÈõ≤È©óË≠âÁôªÂÖ•
		// 604: ÁßÅÈõ≤TokenÈåØË™§, Ë´ãÈáçÊñ∞ÊãâÂèñ/groupsÂèñÁöÑÊñ∞ÁöÑkeyÈÄ≤Ë°åÁßÅÈõ≤È©óË≠âÁôªÂÖ•
		// 605: ÂÖ¨Èõ≤‰∏äÁöÑSSOÂ∏≥ËôüÈúÄË¶ÅÈáçÊñ∞È©óË≠â, ‰∏çÂèØ‰ΩøÁî®Put /authÂèñÂæóÊñ∞ÁöÑToken, ÂÉÖËÉΩ‰ΩøÁî®Put /sso/authÈáçÊñ∞ÈÄ≤Ë°åLDAPÂØÜÁ¢ºÈ©óË≠â
		// 606: ÁßÅÈõ≤‰∏äÁöÑSSOÂ∏≥ËôüÈúÄË¶ÅÈáçÊñ∞È©óË≠â, ‰∏çÂèØ‰ΩøÁî®Put /authÂèñÂæóÊñ∞ÁöÑToken, ÂÉÖËÉΩ‰ΩøÁî®Put /sso/authÈáçÊñ∞ÈÄ≤Ë°åLDAPÂØÜÁ¢ºÈ©óË≠â
		// 607: ÂÖ¨Èõ≤‰∏äÁöÑÊ≠∏Êà∂ LDAP Â∏≥ËôüÂ∑≤Ëß£Èô§, ‰∏çÂãï‰Ωú, Á≠â polling ÁöÑ command 56 ÂÜçÂü∑Ë°åÂúòÈ´îÂàóË°®ÁöÑÊõ¥Êñ∞Âãï‰Ωú (Ê∏ÖÈô§Ê≠∏Êà∂Ë≥áË®ä)
		// 608: ÁßÅÈõ≤‰∏äÁöÑÊ≠∏Êà∂ LDAP Â∏≥ËôüÂ∑≤Ëß£Èô§, ‰∏çÂãï‰Ωú, Á≠â polling ÁöÑ command 56 ÂÜçÂü∑Ë°åÂúòÈ´îÂàóË°®ÁöÑÊõ¥Êñ∞Âãï‰Ωú (Ê∏ÖÈô§Ê≠∏Êà∂Ë≥áË®ä)
		// 609: ‰ºÅÊ•≠Â∏≥ËôüË¢´ÁÆ°ÁêÜËÄÖ‰øÆÊîπÂØÜÁ¢º, Ë´ã‰ΩøÁî®ËÄÖÈáçÊñ∞‰ΩøÁî®Êñ∞ÁöÑÂØÜÁ¢ºÈÄ≤Ë°åÁôªÂÖ•
		// 610: Â∏≥ËôüË¢´ÂáçÁµê, Âº∑Âà∂ÁôªÂá∫, Âêê AP Áµ¶ÁöÑMessage 
		// 611: ‰ªòË≤ªÂ∏≥ËôüË¢´ÈóúÈñâ, Âº∑Âà∂ÁôªÂá∫, Âêê AP Áµ¶ÁöÑMessage 
		// 612: ‰∏ÄËà¨Â∏≥ËôüËÆäÊàêÁÑ°ÊïàÂ∏≥Ëôü, Âº∑Âà∂ÁôªÂá∫, Âêê AP Áµ¶ÁöÑMessage
		// 613: ‰∏ÄËà¨Â∏≥ËôüËÆäÊàêÁÑ°ÊïàÂ∏≥Ëôü, Âº∑Âà∂ÁôªÂá∫, Âêê AP Áµ¶ÁöÑMessage
		
		switch(rspCode) {
			case 601: // ÂÖ¨Èõ≤TokenÈÅéÊúü, ‰ΩøÁî®Put /authÈÄ≤Ë°åÈáçÊñ∞È©óË≠âÂèñÁöÑÊñ∞ÁöÑToken, Â¶ÇÊûúÈ©óË≠âÂ§±ÊïóÂâáË´ãÈáçÊñ∞ÁôªÂÖ• 
				authUpdate();
				break;
			case 602: // ÂÖ¨Èõ≤TokenÈåØË™§, Ê†πÊìö‰πãÂâçÁöÑÊµÅÁ®ã, Â∞áÂº∑Âà∂ÁôªÂá∫
				new QmiGlobal.popup({
					desc: rspObj.rsp_msg,
					confirm: true,
					action: [logout]
				});

				deferred.resolve({
                	isSuccess: false,
                	data: rspData,
	        		isReAuth: true
                });
				break;
			case 603: // ÁßÅÈõ≤TokenÈÅéÊúü, ‰ΩøÁî®Put /authÈÄ≤Ë°åÈáçÊñ∞È©óË≠âÂèñÁöÑÊñ∞ÁöÑToken, Â¶ÇÊûúÈ©óË≠âÂ§±ÊïóÂâáË´ãÈáçÊñ∞ÊãâÂèñ/groupsÂèñÁöÑÊñ∞ÁöÑkeyÈÄ≤Ë°åÁßÅÈõ≤È©óË≠âÁôªÂÖ•
				authUpdate();
				break;
			case 604: // token È©óË≠âÂ§±Êïó ‰∏ÄËà¨ÁßÅÈõ≤ÈáçÊñ∞Âèñkey ÂÅöcert
				authCompanyKey();
				break;
			case 605: // ÂêåË£ùÁΩÆÈáçË§áÁôªÂÖ• ssoÈúÄÁôªÂá∫
				if(QmiGlobal.auth.isSso) {
					new QmiGlobal.popup({
						desc: $.i18n.getString("WEBONLY_LOGOUT_BY_ANOTHER_DEVICE"),
						confirm: true,
						action: [reLogin]
					});
					return;
				}
				authUpdate();
				break;
			case 606: // ÁßÅÈõ≤‰∏äÁöÑSSOÂ∏≥ËôüÈúÄË¶ÅÈáçÊñ∞È©óË≠â, ‰∏çÂèØ‰ΩøÁî®Put /authÂèñÂæóÊñ∞ÁöÑToken, ÂÉÖËÉΩ‰ΩøÁî®Put /sso/authÈáçÊñ∞ÈÄ≤Ë°åLDAPÂØÜÁ¢ºÈ©óË≠â
				if (QmiGlobal.auth.isSso) {
					new QmiGlobal.popup({
						desc: $.i18n.getString("WEBONLY_LOGOUT_BY_ANOTHER_DEVICE"),
						confirm: true,
						action: [reLogin]
					});
					return;
				}
				authUpdate();
				break;
			case 607:
				QmiGlobal.module.reAuthUILock.lock(companyData);
				break;
			case 608:
				QmiGlobal.module.reAuthUILock.lock(companyData);
				break;
			case 609:
				if(QmiGlobal.auth.isSso) {
					new QmiGlobal.popup({
						desc: rspObj.rsp_msg,
						confirm: true,
						action: [reLogin]
					});
					return;
				}
				break;
			case 610:
			case 611:
			case 612:
			case 613:
				new QmiGlobal.popup({
					desc: rspObj.rsp_msg,
					confirm: true,
					action: [logout]
				});

				break;
			case 9999:
				// Ê≤íÂ∏∂rspCode Ë°®Á§∫ÊòØexpire timeÈÅéÊúü
				authUpdate();
				break;
			default:
				deferred.resolve({
                	isSuccess: false,
	        		isReAuth: true
                });
		}

		function authUpdate() {
			// ÈúÄË¶ÅËº∏ÂÖ•ÂØÜÁ¢º
			if((companyData || {}).passwordTp === 1) 
				authUpdateManually();
			else 
				authUpdateAutomatically();
			
		}

		function authUpdateAutomatically() { 
			self.autoUpdateAuth(companyData).done(deferred.resolve);
		}

		function authUpdateManually() { 
			QmiGlobal.module.reAuthUILock.lock(companyData);
			QmiGlobal.module.reAuthManually.init({
				reAuthDef: deferred,
				companyData: companyData
			});
		}

		function authCompanyKey() {
			getCompanyKey({ il: [{
                cdi: companyData.cdi,
                ci: companyData.ci,
                ui: companyData.ui
            }]}).done(function(rspObj){
                if(rspObj.isSuccess === true) {
                	companyData.key = rspObj.key;
                    getCompanyToken(companyData,true).done(function(isSuccess) {
                    	deferred.resolve({
                    		isSuccess: isSuccess,
			        		isReAuth: true
                    	})
                    });
                } else deferred.resolve({
                	isSuccess: false,
                	data: rspObj,
                	msg: "get company's token fail",
	        		isReAuth: true
                });
            })
		}

		return deferred.promise();
	},


	autoUpdateAuth: function(companyData) {
		var self = this;
		var deferred = $.Deferred();

		$.ajax({
		    url: (function(){
				if(companyData.cl === undefined) {
					return base_url + "apiv1/auth";
				} else {
					return "https://" + companyData.cl + "/apiv1/auth";
				}
			})(),

		    headers: self.setHeaders({}, companyData),
		    type: "put",
		    error: function(errData){
		    	// 2018/1/17
		    	// is sso Êõ¥Êñ∞ÈåØË™§Â∞±ÁôªÂá∫
		    	if(QmiGlobal.auth.isSso) {
		    		popupShowAdjust("", $.i18n.getString("LOGIN_AUTO_LOGIN_FAIL") +": "+ QmiGlobal.makeErrCodeStr(1002), true, false,[reLogin]);	//È©óË≠âÂ§±Êïó Ë´ãÈáçÊñ∞ÁôªÂÖ•
		    		return;
		    	}

		    	// 2017/11/03
		    	// etÈÅéÊúü Ëá™ÂãïÊõ¥Êñ∞ ÁôºÁîüÈåØË™§
		    	companyData.isAutoAuthFail = true;
		    	addCompanyReLoadView(companyData);
		    	QmiGlobal.module.reAuthUILock.lock(companyData);

		        deferred.resolve({
		        	isSuccess: false,
		        	data: errData,
		        	isReAuth: true
		        });
		    },

		    success: function(apiData){
		    	// ÈáçÊñ∞Ë®≠ÂÆöat
		    	if(
		    		companyData !== QmiGlobal.auth
		    		&& QmiGlobal.companies[companyData.ci] !== undefined
		    	) {
		    		// ÁßÅÈõ≤
		    		QmiGlobal.companies[companyData.ci].nowAt = apiData.at;
		    		QmiGlobal.companies[companyData.ci].et = apiData.et;
		    	} else {
		    		// ÂÖ¨Èõ≤
		    		QmiGlobal.auth.at = at = apiData.at;
		    		QmiGlobal.auth.et = apiData.et;
		    	}


		        deferred.resolve({
		        	isSuccess: true,
		        	data: apiData,
		        	isReAuth: true
		        });
		    }
		}) // end of reAuth ajax
		
		return deferred.promise();
	},

	onError: function(errData){
		var ajaxArgs = errData.newArgs,
			isPolling = function(){
				return (errData.newArgs.url.match(/sys\/polling/) instanceof Array)
			}();

		s_load_show = false;

		//pollingÈåØË™§‰∏çÈóúÈñâ ÁÇ∫‰∫Üurl parse
		if(isPolling === false){
			QmiGlobal.ajaxLoadingUI.hide();
		}

		//‰∏çÂÅöÈåØË™§È°ØÁ§∫ polling‰πü‰∏çÈ°ØÁ§∫ isCancel ÊâãÂãïËº∏ÂÖ•ÂØÜÁ¢ºÁöÑÁßÅÈõ≤ÈáçÊñ∞È†ÅÈù¢ ÊåâÂèñÊ∂àÂ∞±‰∏çÈ°ØÁ§∫ÈåØË™§Ë®äÊÅØ
		if(ajaxArgs.errHide || ajaxArgs.noErr || isPolling || errData.isCancel === true) return;

		//ajaxÈÄæÊôÇ
		if(errData.statusText == "timeout"){
			// popupShowAdjust("","Á∂≤Ë∑Ø‰∏çÁ©© Ë´ãÁ®çÂæåÂÜçË©¶",true);
			toastShow( $.i18n.getString("COMMON_TIMEOUT_ALERT") );
			return false;
		}

		//logout~
		if(errData.status == 401){
			// ËÅäÂ§©ÂÆ§ÈóúÈñâ
			// if(QmiGlobal.isChatRoom) window.close();

			QmiGlobal.rspCode401 = true;
			popupShowAdjust("", $.i18n.getString("LOGIN_AUTO_LOGIN_FAIL"), true, false,[function() {
				// ËÅäÂ§©ÂÆ§ÈóúÈñâ
				if(QmiGlobal.isChatRoom) window.close();
				else reLogin();
			}]);	//È©óË≠âÂ§±Êïó Ë´ãÈáçÊñ∞ÁôªÂÖ•
			return;
		}
		//ajax ÊèêÁ§∫Ë®äÊÅØÈÅ∏Êìá ÁôªÂÖ•È†ÅÈù¢ÈåØË™§Ë®äÊÅØÁÇ∫popup
		if(args.ajaxMsg === true){
			popupShowAdjust("",errorResponse(errData),true);
		}else{
			//È†êË®≠
			toastShow(errorResponse(errData));
		}
	},

	onComplete: function(data){
		
		if(s_load_show === false) QmiGlobal.ajaxLoadingUI.hide();

	}
} // end of QmiAjax

// ÈñãÈóú„ÄÅÊµÆÊ∞¥Âç∞Ê™¢Êü•
QmiGlobal.method.isSettingAllowed = function(argObj) {
	var type = argObj.tp;
	var typeArr = ["li", "re", "wa"];
	var swObj = QmiGlobal.groups[argObj.gi].newData.sw;
	var result = true;

	switch(argObj.tp) {
		case 2:
			result = 3;
			break;
		default:
			result = !!+swObj[typeArr[argObj.tp]][argObj.eventTp.substring(1)];
	}

	if(result === false) toastShow($.i18n.getString("WEBONLY_FORBIDDEN_FEATURE"));
	return result;
}	



MyDeferred = function() {
  var myResolve, myReject;
  var myPromise = new Promise(function(resolve, reject){
    myResolve = resolve;
    myReject = reject;
  });

  myPromise.resolve = myResolve;
  myPromise.reject = myReject;
  return myPromise;
}

// ÈÅ∏Êìáserver
$(document).on("click", "#container_version", function() {
	var cnts = 0;
	return function() {
		if(cnts === 0) setTimeout(function() {cnts = 0;}, 1000);
		cnts++;
		if(cnts < 5) return;
		QmiGlobal.module.serverSelector.init();
}}());

//‰∏ä‰∏ÄÈ†ÅÂäüËÉΩ
$(document).on("pagebeforeshow",function(event,ui){
	var hash = window.location.hash;

	//ÈÉ®ÂàÜË∑≥È†ÅÂèä‰∏ä‰∏ÄÈ†ÅÊåâÈàï‰∏çÈúÄË¶ÅË®òÈåÑÊ≠∑Á®ã
	if(back_exception){
		back_exception = false;
		return false;
	}

	//ignore same hash continuously
	if(hash === $(document).data("page-history").last()[0]) return;

	var page_title = $(hash + " .page-title").html();
	var page_arr = [hash,page_title];

	$(document).data("page-history").push(page_arr);

	//timelineÈ†ÅÈù¢
	if(hash == "#page-group-main"){
		//Ë™øÊï¥ÂúòÈ´îÈ†≠ÂÉè
		if($(document).data("group-avatar")){
			$(".sm-group-area").each(function(i,val){
				var this_img = $(this).find(".sm-group-area-l img:eq(0)");
				var img = new Image();
				//Êîπ‰ΩøÁî®cssËá™ÂãïË™øÊï¥Â§ßÂ∞è‰ΩçÁΩÆ 2014.11.20 glorialin
				// img.onload = function() {
				// 	mathAvatarPos(this_img,this.width,this.height,avatar_size);
				// }
				img.src = this_img.attr("src");
			});
			//ÊîπÂÆåÂ∞±ÊîπÂõûfalse
			$(document).data("group-avatar",false);
		}
	}
});


$(document).on("click",".page-back",function(){
	// chatroomËá™Â∑±ÊúâÂà§Êñ∑
	if(QmiGlobal.isChatRoom) return;

	if( this.hasAttribute("customize") ) return false;

	//Êåâ‰∏ä‰∏ÄÈ†Å‰∏çÈúÄË¶ÅË®òÈåÑÊ≠∑Á®ã
	back_exception = true;
	var t= $(document).data("page-history");

	//ÁõÆÂâçÈÄôÈ†ÅÂÖàÁßªÈô§
	$(document).data("page-history").pop();

	//Ëã•‰∏ä‰∏ÄÈ†ÅÁÇ∫login Â∞éÂéªlogin
	if( $(document).data("page-history").last()[0] == "login" ) {
		document.location = "index.html";
	}

	$.mobile.changePage($(document).data("page-history").last()[0], {transition: "slide",reverse: true});
	//cns.debug("last:",$(document).data("page-history").last()[0]);
});


//for node-webkit app to open systems browser
$(document).on("click","a",function(e){

	e.stopPropagation()
	if(!$(this).is("[download]")){
		var isNode = (typeof(require) != "undefined");
		cns.debug( isNode );
		if( isNode ){
            var gui = require('nw.gui');
            gui.Shell.openExternal($(this).attr("href"));
			return false;
        }
	}
});


errorResponse = function(data){
	try{
		if(data && data.responseText && data.responseText.length>0 ){
			return $.parseJSON(data.responseText).rsp_msg;
		}else{
			cns.debug("errorResponse:",data);
			return $.i18n.getString("COMMON_CHECK_NETWORK");
		}
	} catch(e){
		cns.debug("catch error", {e:e,data:data} );
		return $.i18n.getString("COMMON_UNKNOWN_ERROR");
	}
}

//debug control
setDebug(debug_flag);

function setDebug(isDebug) {
  if (true) {
    window.cns = {
      log: window.console.log.bind(window.console, '%s: %s'),
      error: window.console.error.bind(window.console, 'error: %s'),
      info: window.console.info.bind(window.console, 'info: %s'),
      warn: window.console.warn.bind(window.console, 'warn: %s'),
      debug: window.console.debug.bind(window.console, 'debug: %s')
    };
  } else {
    var __no_op = function() {};

    window.cns = {
      log: __no_op,
      error: __no_op,
      warn: __no_op,
      info: __no_op,
      debug: __no_op
    }
  }
}


if (typeof Object.assign != 'function') {
  Object.assign = function (target, varArgs) { // .length of function is 2
    'use strict';
    if (target == null) { // TypeError if undefined or null
      throw new TypeError('Cannot convert undefined or null to object');
    }

    var to = Object(target);

    for (var index = 1; index < arguments.length; index++) {
      var nextSource = arguments[index];

      if (nextSource != null) { // Skip over if undefined or null
        for (var nextKey in nextSource) {
          // Avoid bugs when hasOwnProperty is shadowed
          if (Object.prototype.hasOwnProperty.call(nextSource, nextKey)) {
            to[nextKey] = nextSource[nextKey];
          }
        }
      }
    }
    return to;
  };
}

QmiGlobal.ModuleConstructor = function(args) {
	var self = this;
    args = args || {};
    Object.keys(args).forEach(function(key) {
        self[key] = args[key];
    });

    self.data = function() {
        var thisData = {};
        return {
            get: function(key) {
                if(key) return thisData[key];
                return thisData;
            },
            set: function(key, val) {
                thisData[key] = val;
            },
            reset: function() {
                thisData = {};
            },
            developGet: function() {
                return thisData;
            }
        };
    }();

    if(!args.handleEvent) {
    	self.handleEvent = function() {
		    try {
		    	var self = this;
		    	var veTpStr = getGroupVeIdTypeStr(event.type.split(":"+self.id+":").join(":"));

		        if(typeof self[veTpStr] === "function") self[veTpStr]({
		            dom: $(event.detail.elem),
		            data: event.detail.data,
		            evt: event
		        });    
		    } catch(e) {console.error("eventHandler error occured", e);}
		    
		    function getGroupVeIdTypeStr(evtTp) {
		        var evtTpArr = evtTp.split(":");
		        return evtTpArr[0] + evtTpArr[1].substring(0, 1).toUpperCase() + evtTpArr[1].substring(1);
		    }
		};
    }

};

// singleton
QmiGlobal.api = (function() {

	var ApiConstructor = function() {

		this.putCounts = function(args) {
			var body = {cnts: [], gcnts: {}};
			var isGlobalCnt = args.tp.substring(0,1) == "G";

			if(isGlobalCnt)
		        body.gcnts[args.tp] = 0;
		    else {
		        body.cnts[0] = {gi: args.gi};

		        if(args.ci)
		            body.cnts[0].cl = [{[args.tp]: 0, ci: args.ci}];
		        else
		            body.cnts[0][args.tp] = 0;
		    }

			return new QmiAjax({
		        apiName: "sys/counts",
		        method: "put",
		        body: body,
		        isPublicApi: isGlobalCnt
		    });
		}
	}

	return new ApiConstructor();
})()
