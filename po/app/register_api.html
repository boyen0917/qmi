<!DOCTYPE HTML>  
<html>  
<head>  
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">  
    <script src="../js/jquery.js"></script>  
    <script src="js/sha/sha1.js"></script>
    <script src="js/sha/enc-base64-min.js"></script>
    <script type="text/javascript">  
    $(function(){  
    	$.extend({
    		  getUrlVars: function(){
    		    var vars = [], hash;
    		    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
    		    for(var i = 0; i < hashes.length; i++)
    		    {
    		      hash = hashes[i].split('=');
    		      vars.push(hash[0]);
    		      vars[hash[0]] = hash[1];
    		    }
    		    return vars;
    		  },
    		  getUrlVar: function(name){
    		    return $.getUrlVars()[name];
    		  }
    		});
    	
    	// Getting URL var by its nam
    	api_type = $.getUrlVar('api_type');

      if(!api_type) return false;
    	//api 網址
        //var base_url = "https://mapserver.mitake.com.tw/apiv1/";
        var base_url = "https://apserver.mitake.com.tw/apiv1/";
        //var base_url = "http://10.1.17.116:8090/apiv1/";
        
        var ui,at,gi,gn,gd,ga,gm,device_token,zoom_out_cnt,zoom_in_cnt,group_list;
        
        //ajax用
        var myRand = Math.floor((Math.random()*1000)+1);

        switch(api_type){ // groups/{gi}/invitations
            case "geturl":
                var api_name = "me/avatar";

                var headers = {
                     "ui":"0062d0a7-9b59-46c3-988a-c419931b50e6 ",
                     "at":"64da2852-7151-4293-a322-6e31f0611458", 
                     "li":"zh_TW"
                };

                var method = "put";
                var result = ajaxDo(api_name,headers,method,true,body);
            break;
            case "login":
                var api_name = "login";
                var headers = {
                    "li":"zh_TW"
                };
                var body = {
                    "id":"+886980922917",
                    "tp":"0",
                    "pw":toSha1Encode("111111")
                };
                console.debug(body);
                var method = "post";
                var result = ajaxDo(api_name,headers,method,true,body);
                break;
            case "registration":
                //http://localhost/po/app/register_api.html?api_type=registration
                var chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";
                var string_length = 8;
                var randomstring = '';
                for (var i=0; i<string_length; i++) {
                    var rnum = Math.floor(Math.random() * chars.length);
                    randomstring += chars.substring(rnum,rnum+1);
                }
                device_token = "web-" + randomstring;
                var api_name = "registration";

                var headers = {
                         "li":"zh_TW",
                             };
                var method = "post";

                var body = {
                        id: "+886980922917",
                        tp: 0,
                        ud: device_token,
                    }
                                 console.debug("headers",JSON.stringify(headers,null,2));
                                 console.debug("body",JSON.stringify(body,null,2));
                var result = ajaxDo(api_name,headers,method,true,body);
              break;
            
        }
        
        
        result.complete(function(data){
            //console.log($.parseJSON(data.responseText));
            var t =$.parseJSON(data.responseText);
            console.log(t.rsp_code);
            console.log(JSON.stringify(t,null,2));
            
            $("textarea").html(JSON.stringify(t,null,2));
            
        });
        
        return false;
            

        //ajax
        function ajaxDo(api_name,headers,method,load_show_chk,body){
            //設定是否顯示 loading 圖示
            load_show = load_show_chk;

            //console.log(api_url);
            var api_url = base_url + api_name;
            var myRand = Math.floor((Math.random()*1000)+1);

            if(body){
                body = JSON.stringify(body);
            }

            var result = $.ajax ({
                url: api_url,
                type: method,
                headers:headers,
                data:body
            });

            return result;
        }


         function ajaxDos(api_name,headers,method,async,body){
             //console.log(api_url);
             var api_url = base_url + api_name;
             
             if(async){
                 var result = $.ajax ({
                     url: api_url,
                     type: method,
                     headers:headers,
                     data:body
                 });/* ajax結束 */
             }else{
                 var result = $.ajax ({
                     url: api_url,
                     type: method,
                     headers:headers,
                     async:false,
                 });/* ajax結束 */
             }
             
             return result;
         } 
     
         //sha1 and base64 encode
         function toSha1Encode(string){
             var hash = CryptoJS.SHA1(string);
             var toBase64 = hash.toString(CryptoJS.enc.Base64);
             return toBase64;
         }
 });  
   </script>   
</head>  
<body>  
   <textarea style="font-size:15px;width:80%;height:1000px"></textarea>
</body>  
</html>  