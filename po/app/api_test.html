<!DOCTYPE HTML>  
<html>  
<head>  
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">  
    <script src="../js/jquery.js"></script>  
    <script src="js/sha/sha1.js"></script>
    <script src="js/sha/enc-base64-min.js"></script>
    <script type="text/javascript">  
    $(function(){  
    	$.extend({
    		  getUrlVars: function(){
    		    var vars = [], hash;
    		    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
    		    for(var i = 0; i < hashes.length; i++)
    		    {
    		      hash = hashes[i].split('=');
    		      vars.push(hash[0]);
    		      vars[hash[0]] = hash[1];
    		    }
    		    return vars;
    		  },
    		  getUrlVar: function(name){
    		    return $.getUrlVars()[name];
    		  }
    		});
    	
    	// Getting URL var by its nam
    	api_type = $.getUrlVar('api_type');

        var lang = "zh_TW";

      if(!api_type) return false;
    	//api 網址
        // var base_url = "https://apserver.mitake.com.tw/apiv1/";
        var base_url = "https://mapserver.mitake.com.tw/apiv1/";
        //var base_url = "http://10.1.17.116:8090/apiv1/";
        
        var ui,at,gi,gn,gd,ga,gm,device_token,zoom_out_cnt,zoom_in_cnt,group_list;
        
        //ajax用
        var myRand = Math.floor((Math.random()*1000)+1);
     
        var id = "+886980922917";
        //登入認證
        var api_name = "login";

        var headers = {
            li:"zh_TW"
        };
        var body = {
            id: id,
            tp:"0",
            pw:toSha1Encode("111111")
        };
        var method = "post";
        var result = ajaxDo(api_name,headers,method,true,body);
        result.complete(function(data){
        	ui = $.parseJSON(data.responseText).ui;
            at = $.parseJSON(data.responseText).at;
            console.debug(data);
            switch(api_type){ // groups/{gi}/invitations
                case "polling":
                    var api_name = "/sys/polling?pt=1407225112800";

                    var headers = {
                             "ui":ui,
                             "at":at, 
                             "li":"zh_TW",
                                 };
                    var method = "get";
                    var result = ajaxDo(api_name,headers,method,false);
                    break;
            
                case "step3":
                    var api_name = "activation/step3";

                    // etp: 0(讀取),1(按讚),2(按X),3(按訂閱),4(按置頂),6(是否有行事曆)
                    // est: 0(取消),1(執行)
                    var headers = {
                             "ui":ui,
                             "at":at, 
                             "li":"zh_TW",
                                 };
                     var method = "put";
                     var body = {
                      "id": "886980922917",
                      "tp": 0,
                      "ud": "web-test",
                      "fn": "First",
                      "ln": "Last",
                      "bd": "19850922"
                    }
                                     
                    var result = ajaxDo(api_name,headers,method,true,body);
                     
                    break;
                case "me"://這則單一事件的各種回復狀態 Type(0=讀取,1=按讚,2=按X,3=按訂閱,4=按置頂,7=按任務)
                	 var api_name = "me";
                	 var headers = {
                             "ui":ui,
                             "at":at, 
                             "li":"zh_TW"
                                 };
                     var method = "get";
                                     
                     
                    var result = ajaxDo(api_name,headers,method,true);
                     
                	break;
                case "timeline_status"://理解是 自己對於這則timeline event 的各種狀態 is read is like is reply etc...
                    var api_name = "groups/62cd6a3a-77b9-4f84-8f2d-854020665134/timelines/92a940f7-02bd-4413-88fc-57c4f7836ee4/events_status?ep=Event-116";
                    console.log(api_name);
                    var headers = {
                            "ui":ui,
                            "at":at, 
                            "li":"zh_TW"
                                };
                    var method = "get";
                    
                    
                    var result = ajaxDo(api_name,headers,method,true);
                    
                   break;
                case "timeline_list"://動態消息
                    var api_name = "groups/G000000209m/timelines/T00000050AP/events?ct=1405920886582";
                    var headers = {
                            "ui":ui,
                            "at":at, 
                            "li":"zh_TW"
                                };
                    var method = "get";
                    
                    
                    var result = ajaxDo(api_name,headers,method,true);
                    
                   break;
                case "timeline_one"://單一動態消息
                    //var api_name = "groups/e2b777c8-68a7-468e-b9e4-b2434ccb86fb/timelines/3f191b19-d532-43b7-a696-ddd40e020670/events/Event-148";
                    var api_name = "groups/3564cbb8-81a3-47a3-b0f3-89822762029f/timelines/0efb2a90-fb99-4ce8-b80e-646bba745ea6/events/Event-369";
                    var headers = {
                            "ui":ui,
                            "at":at, 
                            "li":"zh_TW"
                                };
                    var method = "get";
                    
                    
                    var result = ajaxDo(api_name,headers,method,true);
                    
                    
                   break;
                   
                case "groups"://所有團體
                    var api_name = "groups";
                    var headers = {
                        "ui":ui,
                        "at":at,
                        "li":"zh_TW",
                    };
                    var method = "get";
                    var result = ajaxDo(api_name,headers,method,true);
                    	//tl 有3個 行事曆 tp=1 ; 動態 2 ; 聊天室 3 
                    	//"{"gl":[{"gi":"83c7be55-5b09-459f-aea6-b345b49b6cab","gn":"三豬雲","ga":"","ad":2,"cnt":11,"tl":[{"ti":"12a6807c-acee-4b1e-8da0-0f84bcb573ac","tp":3},{"ti":"92c954b5-e343-44d5-bf95-70a6ef53ef4e","tp":1},{"ti":"e874c0da-845c-4635-970f-ed4764047960","tp":2}],"me":"85820d46-18a2-4bed-9641-513f74a5e875"}],"rsp_code":0,"rsp_msg":"取得完成"}"
                    
                    	break;
                    
                case "group/user"://單一團體
                	var api_name = "groups/0efa069a-b882-4ea6-a78e-c36966ee4aa1/users";
                    var headers = {
                        "ui":ui,
                        "at":at,
                        "li":"zh_TW",
                    };
                    var method = "get";
                    var result = ajaxDo(api_name,headers,method,true);
                    break;
                case "group/create"://建團    
                    var api_name = "groups";
                    var headers = {
                        "ui":ui,
                        "at":at,
                        "li":"zh_TW",
                    };
                    var body = {
                   		"gn":"brian test",
                        "gd":"哈囉"
                    }
                    

                    var method = "post";

                    console.log(api_name);
                    console.log(headers);
                    console.log(method);
                    console.log(body);
                    var result = ajaxDo(api_name,headers,method,true,body);
                    break;
            }
            
            
            result.complete(function(data){
                var t =$.parseJSON(data.responseText);
                console.log(t.rsp_code);
                console.log(JSON.stringify(t,null,2));
                
                $("textarea").html("api_name:\n"+ api_name + "\n\nheaders:\n"+ JSON.stringify(headers,null,2) + "\n\nresponse:\n" + JSON.stringify(t,null,2));
                
            });
            
            return false;
            
        });
  
        
//ajax

        //ajax
        function ajaxDo(api_name,headers,method,load_show_chk,body){
            //設定是否顯示 loading 圖示
            load_show = load_show_chk;

            //console.log(api_url);
            var api_url = base_url + api_name;
            var myRand = Math.floor((Math.random()*1000)+1);

            if(body){
                body = JSON.stringify(body);
            }

            var result = $.ajax ({
                url: api_url,
                type: method,
                headers:headers,
                data:body
            });

            return result;
        }
     function ajaxDos(api_name,headers,method,async,body){
         //console.log(api_url);
         var api_url = base_url + api_name;
         
         if(async){
             var result = $.ajax ({
                 url: api_url,
                 type: method,
                 headers:headers,
                 data:body
             });/* ajax結束 */
         }else{
             var result = $.ajax ({
                 url: api_url,
                 type: method,
                 headers:headers,
                 async:false,
             });/* ajax結束 */
         }
         
         return result;
     } 
     
     //sha1 and base64 encode
     function toSha1Encode(string){
         var hash = CryptoJS.SHA1(string);
         var toBase64 = hash.toString(CryptoJS.enc.Base64);
         return toBase64;
     }
 });  
   </script>   
</head>  
<body>  
   <textarea style="font-size:15px;width:80%;height:1000px"></textarea>
</body>  
</html>  