<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      .data-show {
        width: 500px;
        height: 500px;
        border: 1px solid black;

      }
    </style>
    <script src="../../js/jquery.js"></script>
    <script src="idb.js"></script>
    <script src="../js/idbstore.min.js"></script>
    <script src="../js/sha/sha1.js"></script>
    <script src="../js/sha/enc-base64-min.js"></script>

   </head>
<body>
  <div class="data-show">
    
  </div>
  <button class="db-all">db all</button>
  <button class="getall">get all</button>
  <button class="add">add</button><br/>
  <div>
    <input class="ei"/>
  </div>
  <button class="getei">get ei</button>


    <script>
    $(function(){

        idbAddTimelineEvent = function(){
            var base_url = "https://apserver.mitake.com.tw/apiv1/";

            var id = "+886980922917";
            //登入認證
            var api_name = "login";

            var headers = {
                li:"zh_TW"
            };
            var body = {
                id: id,
                tp:"0",
                pw:toSha1Encode("111111")
            };
            var method = "post";
            ajaxDo(api_name,headers,method,true,body).complete(function(data){
                ui = $.parseJSON(data.responseText).ui;
                at = $.parseJSON(data.responseText).at;

                //製作timeline
                var api_name = "groups/G000000101A/timelines/T000000202F/events";

                var headers = {
                        ui:ui,
                        at:at, 
                        li:"zh_TW"
                };
                var method = "get";
                var result = ajaxDo(api_name,headers,method,false);
                result.complete(function(data){
                    var timeline_list = $.parseJSON(data.responseText).el;
                    if(data.status == 200){
                        //存db
                        $.each(timeline_list,function(i,val){
                            timeline_events.put(val);
                        });
                    }
                });
            });
        }


        timelineListWrite = function(item){
            console.debug("item:",item);
        }




        $("button.db-all").click(function(){
            indexedDB.webkitGetDatabaseNames().onsuccess = function(sender,args)
            { 
                // console.debug(sender.target.result[0]);
                $(".data-show").html("");
                $.each(sender.target.result,function(i,val){
                    var this_db = $('<div>' + val + ' <button class="db-del">delete</button></div>');
                    this_db.find("button").data("db-name",val)
                    $(".data-show").append(this_db);

                });

            };
        });

        $("button.getall").click(function(){
            timeline_events.getAll(timelineListWrite);
        });


        $("button.add").click(function(){
        });

        $("button.getei").click(function(){
            var ei = $("div .ei").val();
            
            var event_data = idbGetTimelineEvent(ei);
            console.debug("event_data:",event_data);
        });

        idbGetTimelineEvent = function(ei){
            customers.iterate(onItem, {
              index: 'event_id',
              onEnd: function(){

              },
              onError: function(){

              }
            });
        }

        //ajax
        function ajaxDo(api_name,headers,method,load_show_chk,body){
            //設定是否顯示 loading 圖示
            load_show = load_show_chk;

            //console.log(api_url);
            var api_url = base_url + api_name;
            var myRand = Math.floor((Math.random()*1000)+1);

            if(body){
                body = JSON.stringify(body);
            }

            var result = $.ajax ({
                url: api_url,
                type: method,
                headers:headers,
                data:body
            });

            return result;
        }

        //sha1 and base64 encode
         function toSha1Encode(string){
             var hash = CryptoJS.SHA1(string);
             var toBase64 = hash.toString(CryptoJS.enc.Base64);
             return toBase64;
         }
    });
    </script>
</body>
</html>