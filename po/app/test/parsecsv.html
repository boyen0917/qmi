<!DOCTYPE html>
<html>
    <head>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
        <meta charset=utf-8 />
 
        <script>
            $(function() {
                group_str_arr = [];
                relation_arr = [];

                var hierachy_arr = {"name": "root","children": [{"name": "三竹資訊","children": []}]};
                $.ajax({
                    url: "20140411.txt",
                    success: function(data){
                        max_group_cnt=0,group_str_arr=[],relation_arr=[];
                        var split_arr = data.split('\n');
                        //先做第一次的篩選
                        $.each(split_arr,function(i,val){
                            if(val.split(',')[3]){
                                if($.inArray(val.split(',')[3], group_str_arr) < 0){
                                    group_str_arr.push(val.split(',')[3]);
                                }
                            }
                        });
                        //製作各節點關聯
                        $.each(group_str_arr,function(i,val){
                            base_arr = val.split("/");
                            $.each(base_arr,function(i,val){
                                result_val = val;
                                chk = 0;
                                $.each(relation_arr,function(i,val){
                                    if(val[0] == result_val){
                                        chk = 1;
                                        return false;
                                    }
                                });
                                
                                if(chk == 0){
                                    result_child_arr = [];
                                    if(i == 0){
                                        result_child_arr[1] = "三竹資訊";
                                    }else{
                                        result_child_arr[1] = base_arr[i-1];
                                    }
                                    result_child_arr[0] = val;
                                    relation_arr.push(result_child_arr);
                                }
                            });
                        });
                        
                        $.each(relation_arr,function(i,val){
                            dup_chk=0;
                            doEach(hierachy_arr.children,val);
                            
                        });

                        hierachy_arr = hierachy_arr.children[0];
                        
                        console.log(JSON.stringify(hierachy_arr));
                        return false;
                        
                        function doEach(arr,target_arr){
                            
                            if(!target_arr){
                                return false;
                            }
                            
                            $.each(arr,function(i,val){
                                
                                if(val.name == target_arr[1]){
                                    
                                    //排除重複
                                    if(val.children){
                                        $.each(val.children,function(i,val){
                                            if(val.name == target_arr[0]){
                                                dup_chk = 1;
                                            }
                                        });
                                    }
                                    
                                    if(dup_chk != 0){
                                        return false;    
                                    }
                                    
                                    if(!val.children){
                                        val.children = [];
                                    }
                                    val.children.push({"name":target_arr[0]+""});
                                    return false;
                                }
                                if(val.children){
                                    doEach(val.children,target_arr);   
                                }
                            });
                        }
                    }
                });
            });
    
        </script>
 
    </head>
    <body>
 
    </body>
</html>