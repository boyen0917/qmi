<!DOCTYPE html>
<html>
    <head>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
        <meta charset=utf-8 />
 
        <script>
            $(function() {
                var hierachy_arr={"name": "三竹資訊","children": []};
                         
                $.ajax({
                    url: "20140411.txt",
                    success: function(data){
                    	max_group_cnt=0,group_str_arr=[],relation_arr=[];
                    	var split_arr = data.split('\n');
                        //先做第一次的篩選
                        $.each(split_arr,function(i,val){
                            if(val.split(',')[3]){
                                if($.inArray(val.split(',')[3], group_str_arr) < 0){
                                    group_str_arr.push(val.split(',')[3]);
                                }
                                
                                //找出最大的階層數
                                if(max_group_cnt < val.split(',')[3].split('/').length){
                                    max_group_cnt = val.split(',')[3].split('/').length;
                                }
                            }
                        });
                        
                        
                    	//製作各節點關聯
                    	$.each(group_str_arr,function(i,val){
                            base_arr = val.split("/");
                            $.each(base_arr,function(i,val){
                                result_val = val;
                                chk = 0;
                                $.each(relation_arr,function(i,val){
                                    if(val[0] == result_val){
                                        chk = 1;
                                        return false;
                                    }
                                });
                                
                                if(chk == 0){
                                    result_child_arr = [];
                                    if(i == 0){
                                        result_child_arr[1] = null;
                                    }else{
                                        result_child_arr[1] = base_arr[i-1];
                                    }
                                    result_child_arr[0] = val;
                                    relation_arr.push(result_child_arr);
                                }
                            });
                        });
                       
                        $.each(relation_arr,function(i,val){
                            count=0
                            doEach(hierachy_arr.children,val);
                        });
                        console.log(JSON.stringify(hierachy_arr));
                        return false;
                        
                        function doEach(arr,target_arr){
                            if(!target_arr){
                                return false;
                            }
                            
                            //第一層特別處理
                            if(target_arr[1] == null){
                                arr.push({"name":target_arr[0]});
                                return false;
                            }
                            
                            if(count < max_group_cnt){
                            	console.log(max_group_cnt);
                                count++;
                                $.each(arr,function(i,val){
                                    if(val.name == target_arr[1]){
                                        if(!val.children){
                                            val.children = [];
                                        }
                                        val.children.push({"name":target_arr[0]+"          "});
                                        return false;
                                    }
                                    if(val.children){
                                        doEach(val.children,target_arr);   
                                    }
                                });
                            }else{
                                return false;
                            }
                        }
                    }// success end
                });// ajax end
                
	                
            });
    
        </script>
 
    </head>
    <body>
 
    </body>
</html>