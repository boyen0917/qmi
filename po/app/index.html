<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Project O</title>
        <link rel="stylesheet" href="../css/jquery.mobile-1.3.2.min.css" />
        <link rel="stylesheet" href="css/main.css" />
        <script src="../js/jquery.js"></script>
        <script src="../js/jquery.mobile-1.3.2.min.js"></script>
    </head>
    <body>
        <div data-role="page" id="page-login">
	        <div class="main launch_kv">
	            <div class="login-area">
	             <input type="text" id="phone" placeholder="&nbsp;帳&nbsp;號">
	             <input type="password" id="code" placeholder="&nbsp;密&nbsp;碼">
	             
	             <span class="login-radio"><img src="images/radio.png"/></span><span class="login-text">記住帳號</span>
	             <a href="#" id="login" data-role="button" data-theme="d" >登&nbsp;&nbsp;入</a>
	             <a class="login-text-l" href="#">忘記密碼?</a>
	             <a class="login-text-r" href="#page-register">註冊帳號</a>
	            </div>
	        </div>
	        
        </div>
<!---------------------------------- page-register ------------------------------------>
        <div data-role="page" id="page-register">
            <div data-theme="c" data-role="header" data-position="fixed" data-tap-toggle="false">
            <a data-role="button" data-rel="back" data-icon="back" data-iconpos="left" class="ui-btn-left">back</a>
                <h3>行動電話號碼註冊</h3>
            </div>
            <div data-role="content">
                <input type="text" id="countrycode" value="地區&nbsp;&nbsp;&nbsp;&nbsp;+886&nbsp;台灣" readonly>
                 <input type="text" id="r-phone" maxlength=10 placeholder="請輸入手機號碼" onkeyup="value=value.replace(/[^-_0-9]/g,'')"/>
                 <div class="register-desc-area">
                    <span class="register-radio"><img src="images/radio2.png"/></span>
                    <span class="register-text">
                        我看過並同意
                        <a href="#">使用條款</a>及
                        <a href="#">隱私政策</a>
                    </span>
                 </div>
                 
                 <a href="#" id="register-next" data-role="button" data-theme="b" >下一步</a>
            </div>
        </div>
<!---------------------------------- page-register-auth ------------------------------------>
        <div data-role="page" id="page-register-auth">
            <div data-theme="c" data-role="header" data-position="fixed" data-tap-toggle="false">
            <a data-role="button" data-rel="back" data-icon="back" data-iconpos="left" class="ui-btn-left">back</a>
                <h3>行動電話號碼認證</h3>
            </div>
            <div data-role="content">
                 <div class="register-desc-area">
                     我們已經將驗證碼傳送至下列電話號碼，請輸入驗證碼已完成您的手機號碼認證。<br/>
                     <h1></h1>
                     <input type="text" id="otp" maxlength=6 placeholder="驗證碼" onkeyup="value=value.replace(/[^-_0-9]/g,'')"/>
                 </div>
                
                 <div class="resend-otp-close">重送驗證碼</div>
                 <a href="#" id="resend-otp" data-role="button" data-theme="b" >重送驗證碼</a>
                 <a href="#page-password" id="register-auth-next" data-role="button" data-theme="b" >下一步</a>
            </div>
        </div>
<!---------------------------------- page-password ------------------------------------>
        <div data-role="page" id="page-password">
            <div data-theme="c" data-role="header" data-position="fixed" data-tap-toggle="false">
            <a data-role="button" data-rel="back" data-icon="back" data-iconpos="left" class="ui-btn-left">返回</a>
                <h3>密碼設定</h3>
            </div>
            <div data-role="content">
                <input type="password" id="pw-setting" maxlength=20 placeholder="請輸入6-20半形英數字" onkeyup="value=value.replace(/[^-_A-Z0-9a-z]/g,'')">
                <input type="password" id="pw-setting-c" maxlength=20 placeholder="請重複輸入密碼"/>
                
                <a href="#" id="pw-send" data-role="button" data-theme="b" >確認</a>
            </div>
        </div>
<!---------------------------------- page-helper ------------------------------------>
        <div data-role="page" id="page-helper">
            <div data-theme="c" data-role="header" data-position="fixed" data-tap-toggle="false">
            <a data-role="button" data-rel="back" data-icon="back" data-iconpos="left" class="ui-btn-left">返回</a>
                <h3>團體建立/加入</h3>
            </div>
            <div class="helper-top-area">
			    <a href="#page-group-menu" class="hg-create" data-role="button" data-inline="true">立即創建團體</a>
			    <a href="#page-group-menu" class="hg-join" data-role="button" data-inline="true">立即加入團體</a>
			</div>
			<div class="helper-title">小幫手</div>
			<div data-role="collapsible-set" class="helper-collapsible-area ui-icon-alt" data-inset="false" data-iconpos="right" data-collapsed-icon="arrow-d">
                <div data-role="collapsible"><h3>如何創建團體</h3><p><ol><li>於"團體列表"的頁面中,點選右上方的"+".</li><li>點選"創建團體"後,設定您的團體照片,輸入團體名稱,團體介紹,並選取""預定使用人數".</li><li>完成輸入後,點擊"建立",即完成團體之建立.</li></ol></p><a class="hg-create inline-btn" href="#page-group-menu" data-role="button" data-theme="d" data-inline="true">立即創建團體</a><br/></div> 
                <div data-role="collapsible"><h3>如何加入團體</h3><p><ol><li>於"團體列表"的頁面中,點選右上方的"+".</li><li>點選"加入團體"後,輸入您來自"簡訊"或"邀請訊息"內的組織代碼及OTP</li><li>完成輸入後,點擊"加入",即加入該團體.</li></ol></p><a class="hg-join inline-btn" href="#page-group-menu" data-role="button" data-theme="d" data-inline="true">立即加入團體</a><br/></div> 
                <div data-role="collapsible"><h3>建立事件提醒重要事項</h3><p>建立事件提醒重要事項</p></div> 
                <div data-role="collapsible"><h3>舉辦投票不漏聽任何人的心聲</h3><p>舉辦投票不漏聽任何人的心聲</p></div> 
                <div data-role="collapsible"><h3>多人群聊加快訊息傳遞</h3><p>多人群聊加快訊息傳遞</p></div> 
            </div><!-- /collapsible -->
        </div>
<!---------------------------------- page-group-menu ------------------------------------>
        <div data-role="page" id="page-group-menu">
            <div data-theme="c" data-role="header" data-position="fixed" data-tap-toggle="false">
                <a data-role="button" data-rel="back" data-icon="back" data-iconpos="left" class="ui-btn-left">返回</a>
                <h3>團體列表</h3>
                <div id="group-nav-area" data-role="navbar">
			        <ul>        
                        <li><a href="#" data-group-act="gl">團體列表</a></li>
                        <li><a href="#" data-group-act="gc">創建團體</a></li>
                        <li><a href="#" data-group-act="gj">加入團體</a></li>
                        <li><a href="#" data-group-act="gi">團體邀請</a></li>
                    </ul>
			    </div>
            </div>
            
            <div class="group-nav-chk" data-group-act="gl">
            </div>
            <div class="group-nav-chk" data-group-act="gc">
                <img class="gm-create-head" src="images/head.png"/>
                <div class="gm-create-content-area">
                    團體名稱
                    <input type="text" id="group-name" placeholder="請輸入您的團體名稱">
                    團體介紹
                    <textarea name="textarea-8" id="group-desc"></textarea>
                    <a href="#" id="gm-create-submit" data-role="button" data-theme="b" >建立</a>
                </div>
            </div>
            <div class="group-nav-chk" data-group-act="gj">
	            <div class="gm-join-area">
	                <input type="text" id="gm-group-num" placeholder="團體編號">
	                <input type="text" id="gm-group-pw" placeholder="團體密碼"/>
	                <a href="#" id="gm-join-submit" data-role="button" data-theme="b" >確認</a>
	            </div>
            </div>
            <div class="group-nav-chk" data-group-act="gi">
            團體邀請
            </div>
        </div>
<!---------------------------------- page-group-main ------------------------------------>
        <div data-role="page" id="page-group-main">
            <div data-theme="c" data-role="header" data-position="fixed" data-tap-toggle="false">
            <a data-role="button" data-rel="back" data-icon="back" data-iconpos="left" class="ui-btn-left">返回</a>
                <h3>成員</h3>
            </div>
            <div class="group-list-main-area">
                <img width="100%" height="100%" src="images/test.png"/>
            </div>
        </div>   
        
<div class="popup">
  <div class="popup-frame">
  <div class="popup-text"></div>
  <a href="#" class="popup-close" data-role="button" data-inline="true">確定</a>
  </div>
  <div class="popup-screen"></div>
</div>

<div class="ui-loader ui-corner-all ui-body-a ui-loader-default"><span class="ui-icon ui-icon-loading"></span><h1>loading</h1></div>

        
        <script type="text/javascript">
            $(function(){
            	//api 網址
                var base_url = "https://apserver.mitake.com.tw/apiv1/";
            	//ajax用
                var myRand = Math.floor((Math.random()*1000)+1);
                
                //全域
                var ui,at,gi,gn,gd,ga,gm,device_token;
                //計算螢幕長寬以維持比例
            	var proportion = 1.7;
            	$(".main").css("width",$(window).width());
            	$(".main").css("height",$(window).width()*proportion);
                $(window).resize(function(){ 
                	$(".main").css("width",$(window).width());
                	$(".main").css("height",$(window).width()*proportion);
                });
                
                //計算彈出對話框置中
                $(document).on("click",function(){
                	if($(".popup").is(":visible")){
                		$(".popup-frame").css("margin-left",($(document).width() - $(".popup-frame").width())/2-15);
                	}
                });
                
                $(".popup-screen").click(function(){
                    $(".popup").hide();
                    $(".popup-screen").hide();
                });
                
                $(".popup-close").click(function(){
                	$(".popup-screen").trigger("click");
                	$(".popup-close").trigger("pageChange");
                });
                
                
                $(document).ajaxSend(function(r, s) {
                	$('.ui-loader').css("display","block");
                	console.log($('.ui-loader').css("display"));
                });
                $(document).ajaxComplete(function(r, s) {
                	$('.ui-loader').hide();
                });
                
                
                
//----------------------------------- 登入 ---------------------------------------------
                //login打勾
                $(".login-radio").click(function(){
                    $(".login-radio img").toggle();
                });
                
                //login
                $("#login").click(function(){
                    //登入認證
                    var api_name = "login";
                    var headers = {
                        "pn":$("#phone").val(),
                        "up":$("#code").val(), 
                        "gm":""
                    };
                    var method = "post";
                    var result = ajaxDo(api_name,headers,method);
                    if(result.status != 200){
                    	$(".popup-text").html("帳號或密碼不對");
                    	$(".popup").show();
                    }else{
                    	ui = $.parseJSON(result.responseText).ui;
                        at = $.parseJSON(result.responseText).at;
                        console.log(ui + " && " + at);
                        //取得團體列表
                        var api_name = "me/groups";
                        var headers = {
                            "ui":ui,
                            "at":at
                        };
                        var method = "get";
                        result = ajaxDo(api_name,headers,method);
                        console.log(result);
                        if(result.responseText){
		                    $("#group-nav-area li a[data-group-act=gl]").trigger("click");
                        	$.mobile.changePage("#page-group-menu", {transition: "pop"});
                        }else{
                        	$.mobile.changePage("#page-helper");
                        }
                    }
                });
//----------------------------------- 註冊 --------------------------------------------- 
                //register打勾
                $(".register-radio").click(function(){
                    $(".register-radio img").toggle();
                });

                //註冊頁面點選下一步 送出驗證碼
                $("#register-next").click(function(){
                	if(!$("#r-phone").val()){
                		$('.popup-text').html("請輸入電話號碼");
                		$('.popup').show();  
                		return false;
                    }else if($(".register-radio img").css("display") == "none"){
                        $('.popup-text').html("請勾選\"看過並同意使用條款及隱私政策\"");
                        $('.popup').show();      
                        return false;
                    }else{
                    	
                    	$(".register-desc-area h1").html($("#r-phone").val());
                    	
                    	//亂數device token
                    	var chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";
					    var string_length = 8;
					    var randomstring = '';
					    for (var i=0; i<string_length; i++) {
					        var rnum = Math.floor(Math.random() * chars.length);
					        randomstring += chars.substring(rnum,rnum+1);
					    }
					    device_token = "web-" + randomstring;
					  //取得otp驗證碼
                    	var api_name = "register/otp";
                    	var headers = {
                    		"cc":"886",
							"pn":$("#r-phone").val(), 
							"di":device_token,
							"ug":"1"
                    	};
                    	var method = "get";
                    	var result = ajaxDo(api_name,headers,method,true);
                    	result.complete(function(data){
                    		if(data.status != 200){
                    			$('.popup-text').html("電話號碼錯誤");
                                $('.popup').show(); 
                    		}else{
                    			$.mobile.changePage("#page-register-auth");
                    		}
                    	});
                    	
                    }
                });
                
                //認證頁面點選下一步
                $("#register-auth-next").click(function(){
                    if(!$("#otp").val()){
                        $('.popup-text').html("驗證碼輸入錯誤，請輸入正確的驗證碼。");
                        $('.popup').show();                        
                        $(".resend-otp-close").hide();
                        $("#resend-otp").css("display","block");
                        return false;
                    }else{
                      //取得otp驗證碼
                        var api_name = "register/otp";
                        var headers = {
                            "cc":"886",
                            "pn":$("#r-phone").val(), 
                            "di":device_token,
                            "op":$("#otp").val()
                        };
                        var method = "post";
                        //非同步
                        var result = ajaxDo(api_name,headers,method);

                        if(!result.responseText){
                            $('.popup-text').html("驗證碼輸入錯誤，請輸入正確的驗證碼。");
                            $('.popup').show();
                            $(".resend-otp-close").hide();
                            $("#resend-otp").css("display","block");
                            return false;
                        }else{
                        	ui = $.parseJSON(result.responseText).ui;
                        	at = $.parseJSON(result.responseText).at;
                        }
                    }
                });
                
              //重送驗證碼
                $("#resend-otp").click(function(){
                	//取得otp驗證碼
                    var api_name = "register/otp";
                    var headers = {
                        "cc":"886",
                        "pn":$("#r-phone").val(), 
                        "di":device_token,
                        "ug":"1"
                    };
                    var method = "get";
                    ajaxDo(api_name,headers,method,true);
                    $('.popup2 p').html("<br/>驗證碼已送出。<br/><br/>");
                    $('.popup2').popup('open');
                	$(".resend-otp-close").show();
                    $("#resend-otp").css("display","none");
                });

                //密碼設定
                $("#pw-send").click(function(){
                    if(($("#pw-setting").val() != $("#pw-setting-c").val()) || $("#pw-setting").val().length < 6){
                        $('.popup').show();
                        return false;
                    }else{
                    	var api_name = "me/password";
                        var headers = {
                            "ui":ui, 
							"at":at, 
							"up":$("#pw-setting").val(),
							"pn":$("#r-phone").val(), 
							"gm":"", 
							"op":$("#otp").val()
                        };
                        var method = "put";
                        //非同步 才能取值
                        var result = ajaxDo(api_name,headers,method);
                        if(!result.responseText){
                        	$('.popup-text').html("<br/>密碼輸入錯誤。<br/><br/>");
                            $('.popup').show();
                        }else{
                        	$('.popup-text').html("<br/>密碼變更完成。<br/><br/>");
                        	$('.popup').show();
                        	popupAfterChangePage("#page-helper");
                        }
                    }
                });
//----------------------------------- 團體選單 ---------------------------------------------                
                //團體選單 點選團體
                $(document).on('click','.group-list-box',function(e){
		            console.log($(this).data("gi"));
		            $.mobile.changePage("#page-group-main");
		        });
                
                //團體選單 點選nav
                $("#group-nav-area li a").click(function(){
                    var act = $(this).data("group-act");
                    $(".group-nav-chk").each(function(i,val){
                        if($(this).data("group-act") == act){
                            $(this).fadeIn();
                            //個別的動作
                            switch (act) {
	                            case "gl": 
	                                groupMenuListArea(ui,at);
	                              break;
	                            case "gc": 
	                                $(".group-create-area").find("input").val("");
	                                $(".group-create-area").find("textarea").val("");
	                              break;
	                            case "gj":
	                              break;
	                            case "gi":
	                              break;
	                        }
                        }else{
                            $(this).hide();
                        }
                    });
                });
                
                //創建團體 建立
                $("#gm-create-submit").click(function(){
                	if(!$("#group-name").val()){
                		console.log("ddd");
                		$('.popup-text').html('<br/>團體名稱不可空白<br/><br/>');
                		$('.popup').show();
                		return false;
                	}else{
                		var api_name = "groups/new";
                        var headers = {
                            "ui":ui,
                            "at":at,
                            "gn":encodeURI($("#group-name").val()),
                            "gd":encodeURI($("#group-desc").val())
                        };
                        var method = "post";
                        console.log(ui);
                        
                        var result = ajaxDo(api_name,headers,method);
                        console.log(api_name);
                        console.log(headers);
                        console.log(method);
                        if(result.status == 200){
                        	
                        	$('.popup-text').html("<br/>創建成功。<br/><br/>");
                            $('.popup').show();
                        }else{
                        	$('.popup-text').html('<br/>未知錯誤<br/><br/>');
                        	$('.popup').show();
                            return false;
                        }
                	}
                });
//----------------------------------- 小幫手 ---------------------------------------------
                //小幫手 創建團體
                $(".hg-create").click(function(){
                	$("#group-nav-area li a[data-group-act=gc]").trigger("click");
                	$("#group-nav-area li a[data-group-act=gc]").addClass("ui-btn-active");
                });
                //小幫手 加入團體
                $(".hg-join").click(function(){
                	$("#group-nav-area li a[data-group-act=gj]").trigger("click");
                	$("#group-nav-area li a[data-group-act=gj]").addClass("ui-btn-active");
                });
                
                
//----------------------------------- function ---------------------------------------------                
                //ajax
                function ajaxDo(api_name,headers,method,async){
                    //console.log(api_url);
                    var api_url = base_url + api_name;
                    var myRand = Math.floor((Math.random()*1000)+1);
                    
                    if(async){
                    	var result = $.ajax ({
                            url: api_url,
                            type: method,
                            headers:headers,
                        });/* ajax結束 */
                    }else{
                    	var result = $.ajax ({
                            url: api_url,
                            type: method,
                            headers:headers,
                            async:false,
                        });/* ajax結束 */
                    }
                    
                    return result;
                }
                
                function groupMenuListArea(ui,at){
                	$("div[data-group-act=gl]").html("");
                	var api_name = "me/groups";
                    var headers = {
                        "ui":ui,
                        "at":at
                    };
                    var method = "get";
                    result = ajaxDo(api_name,headers,method);
                    if(result.responseText){
                    	console.log("test1");
                        $.each($.parseJSON(result.responseText).gl,function(i,val){
                        	$("div[data-group-act=gl]").append("<div data-gi=\"" + decodeURI(val.gi) + "\" class=\"group-list-box\">no pic<div>" + decodeURI(val.gn) + "</div></div>");
                        });
                    }else{
                    	
                    }
                }
		        
                function popupAfterChangePage(dest){
                	$(".popup-close").bind("pageChange",function(){
                		$.mobile.changePage(dest);
                		$(".popup-close").unbind("pageChange");
                	});
                }
            });
        </script>
    </body>
</html>