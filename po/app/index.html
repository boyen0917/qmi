<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Project O</title>
        <link rel="stylesheet" href="../css/jquery.mobile-1.3.2.min.css" />
        <link rel="stylesheet" href="css/main.css" />
        <script src="../js/jquery.js"></script>
        <script src="../js/jquery.mobile-1.3.2.min.js"></script>
        <script src="js/sha/sha1.js"></script>
        <script src="js/sha/enc-base64-min.js"></script>
    </head>
    <body>
        <div data-role="page" id="page-login">
	        <div class="main launch_kv">
	            <div class="login-area">
	             <input type="text" id="phone" placeholder="&nbsp;帳&nbsp;號" value="0980922917">
	             <input type="password" id="code" placeholder="&nbsp;密&nbsp;碼" value="123456">
	             
	             <span class="login-radio"><img src="images/radio.png"/></span><span class="login-text">記住帳號</span>
	             <a href="#" id="login" data-role="button" data-theme="d" >登&nbsp;&nbsp;入</a>
	             
	             <a class="login-text-l" href="#">忘記密碼?</a>
	             <a class="login-text-r" href="#page-register">註冊帳號</a>
	            </div>
	        </div>
	        
        </div>
<!---------------------------------- page-register ------------------------------------>
        <div data-role="page" id="page-register">
            <div data-theme="c" data-role="header" data-position="fixed" data-tap-toggle="false">
            <div class="page-back"></div>
                <h3>行動電話號碼註冊</h3>
            </div>
            <div data-role="content">
                <input type="text" id="countrycode" value="地區&nbsp;&nbsp;&nbsp;&nbsp;+886&nbsp;台灣" readonly>
                 <input type="text" id="r-phone" maxlength=10 placeholder="請輸入手機號碼" onkeyup="value=value.replace(/[^-_0-9]/g,'')"/>
                 <div class="register-desc-area">
                    <span class="register-radio"><img src="images/radio2.png"/></span>
                    <span class="register-text">
                        我看過並同意
                        <a href="#">使用條款</a>及
                        <a href="#">隱私政策</a>
                    </span>
                 </div>
                 
                 <a href="#" id="register-next" data-role="button" data-theme="b" >下一步</a>
            </div>
        </div>
<!---------------------------------- page-register-auth ------------------------------------>
        <div data-role="page" id="page-register-auth">
            <div data-theme="c" data-role="header" data-position="fixed" data-tap-toggle="false">
            <div class="page-back"></div>
                <h3>行動電話號碼認證</h3>
            </div>
            <div data-role="content">
                 <div class="register-desc-area">
                     我們已經將驗證碼傳送至下列電話號碼，請輸入驗證碼已完成您的手機號碼認證。<br/>
                     <h1></h1>
                     <input type="text" id="otp" maxlength=6 placeholder="驗證碼" onkeyup="value=value.replace(/[^-_0-9]/g,'')"/>
                 </div>
                
                 <div class="resend-otp-close">重送驗證碼</div>
                 <a href="#" id="resend-otp" data-role="button" data-theme="b" >重送驗證碼</a>
                 <a href="#" id="register-auth-next" data-role="button" data-theme="b" >下一步</a>
            </div>
        </div>
<!---------------------------------- page-password ------------------------------------>
        <div data-role="page" id="page-password">
            <div data-theme="c" data-role="header" data-position="fixed" data-tap-toggle="false">
            <div class="page-back"></div>
                <h3>密碼設定</h3>
            </div>
            <div data-role="content">
                <input type="password" id="pw-setting" maxlength=20 placeholder="請輸入6-20半形英數字" onkeyup="value=value.replace(/[^-_A-Z0-9a-z]/g,'')">
                <input type="password" id="pw-setting-c" maxlength=20 placeholder="請重複輸入密碼"/>
                
                <a href="#" id="pw-send" data-role="button" data-theme="b" >確認</a>
            </div>
        </div>
<!---------------------------------- page-helper ------------------------------------>
        <div data-role="page" id="page-helper">
            <div data-theme="c" data-role="header" data-position="fixed" data-tap-toggle="false">
            <div class="page-back"></div>
                <h3>團體建立/加入</h3>
            </div>
            <div class="helper-top-area">
			    <a href="#page-group-menu" class="hg-create" data-role="button" data-inline="true">立即創建團體</a>
			    <a href="#page-group-menu" class="hg-join" data-role="button" data-inline="true">立即加入團體</a>
			</div>
			<div class="helper-title">小幫手</div>
			<div data-role="collapsible-set" class="helper-collapsible-area ui-icon-alt" data-inset="false" data-iconpos="right" data-collapsed-icon="arrow-d">
                <div data-role="collapsible"><h3>如何創建團體</h3><p><ol><li>於"團體列表"的頁面中,點選右上方的"+".</li><li>點選"創建團體"後,設定您的團體照片,輸入團體名稱,團體介紹,並選取""預定使用人數".</li><li>完成輸入後,點擊"建立",即完成團體之建立.</li></ol></p><a class="hg-create inline-btn" href="#page-group-menu" data-role="button" data-theme="d" data-inline="true">立即創建團體</a><br/></div> 
                <div data-role="collapsible"><h3>如何加入團體</h3><p><ol><li>於"團體列表"的頁面中,點選右上方的"+".</li><li>點選"加入團體"後,輸入您來自"簡訊"或"邀請訊息"內的組織代碼及OTP</li><li>完成輸入後,點擊"加入",即加入該團體.</li></ol></p><a class="hg-join inline-btn" href="#page-group-menu" data-role="button" data-theme="d" data-inline="true">立即加入團體</a><br/></div> 
                <div data-role="collapsible"><h3>建立事件提醒重要事項</h3><p>建立事件提醒重要事項</p></div> 
                <div data-role="collapsible"><h3>舉辦投票不漏聽任何人的心聲</h3><p>舉辦投票不漏聽任何人的心聲</p></div> 
                <div data-role="collapsible"><h3>多人群聊加快訊息傳遞</h3><p>多人群聊加快訊息傳遞</p></div> 
            </div><!-- /collapsible -->
        </div>
<!---------------------------------- page-group-menu ------------------------------------>
        <div data-role="page" id="page-group-menu">
            <div data-theme="c" data-role="header" data-position="fixed" data-tap-toggle="false">
                <div class="page-back"></div>
                <h3>團體列表</h3>
                <div id="group-nav-area" data-role="navbar">
			        <ul>        
                        <li><a href="#" data-group-act="gc">創建團體</a></li>
                        <li><a href="#" data-group-act="gj">加入團體</a></li>
                        <li><a href="#" data-group-act="gi">團體邀請</a></li>
                    </ul>
			    </div>
            </div>
            
            <div class="group-nav-chk" data-group-act="gl">
            </div>
            <div class="group-nav-chk" data-group-act="gc">
                <img class="gm-create-head" src="images/head.png"/>
                <div class="gm-create-content-area">
                    團體名稱
                    <input type="text" id="group-name" placeholder="請輸入您的團體名稱">
                    團體介紹
                    <textarea name="textarea-8" id="group-desc"></textarea>
                    <a href="#" id="gm-create-submit" data-role="button" data-theme="b" >建立</a>
                </div>
            </div>
            <div class="group-nav-chk" data-group-act="gj">
	            <div class="gm-join-area">
	                <input type="text" id="gm-group-num" placeholder="團體編號">
	                <input type="text" id="gm-group-pw" placeholder="團體密碼"/>
	                <a href="#" id="gm-join-submit" data-role="button" data-theme="b" >確認</a>
	            </div>
            </div>
            <div class="group-nav-chk" data-group-act="gi">
            團體邀請
            </div>
        </div>
<!---------------------------------- page-group-main ------------------------------------>
        <div data-role="page" id="page-group-main">
            <div data-role="panel" id="side-menu" data-display="push">
	            <div class="sm-user-area">
	               <div class="sm-user-area-l"></div>
                   <div class="sm-user-area-r"></div>
	            </div>
	            <div data-sm-act="feed" class="sm-small-area">
                   <div class="sm-small-area-l"><img src="images/side_menu/sidemenu_icon_feed.png"/></div>
                   <div class="sm-small-area-r">動態消息</div>
                   <div class="sm-count">315</div>
                </div>
	            <div data-sm-act="contact" class="sm-small-area">
                   <div class="sm-small-area-l"><img src="images/side_menu/sidemenu_icon_contact.png"/></div>
                   <div class="sm-small-area-r">聯絡人</div>
                   <div class="sm-count"></div>
                </div>
                <div data-sm-act="chat" class="sm-small-area">
                   <div class="sm-small-area-l"><img src="images/side_menu/sidemenu_icon_chat.png"/></div>
                   <div class="sm-small-area-r">聊天</div>
                   <div class="sm-count"></div>
                </div>
                <div data-sm-act="calendar" class="sm-small-area">
                   <div class="sm-small-area-l"><img src="images/side_menu/sidemenu_icon_calendar.png"/></div>
                   <div class="sm-small-area-r">行事曆</div>
                   <div class="sm-count"></div>
                </div>
                <div class="sm-hr">團體</div>
                <div class="sm-group-list-area">
                  
                </div>
                <div class="sm-group-list-area-add">
                    
                </div>
                <div class="sm-group-switch"><div class="sm-switch-ui-adj"></div><img src="images/side_menu/sidemenu_slidedown_icon_none.png"/></div>
                <div class="sm-group-cj">
	                <div class="hg-create sm-group-cj-btn">新增團體</div>
	                <div class="hg-invited sm-group-cj-btn" >團體邀請</div>
	            </div>
                <div class="sm-hr">系統</div>
                <div data-sm-act="help" class="sm-small-area">
                   <div class="sm-small-area-l"><img src="images/side_menu/sidemenu_icon_help.png"/></div>
                   <div class="sm-small-area-r">幫助</div>
                </div>
                <div data-sm-act="news" class="sm-small-area">
                   <div class="sm-small-area-l"><img src="images/side_menu/sidemenu_icon_news.png"/></div>
                   <div class="sm-small-area-r">最新消息</div>
                </div>
                <div data-sm-act="setting" class="sm-small-area">
                   <div class="sm-small-area-l"><img src="images/side_menu/sidemenu_icon_setting.png"/></div>
                   <div class="sm-small-area-r">系統設定</div>
                </div>
            </div>
            <div data-theme="c" data-role="header" data-position="fixed" data-tap-toggle="false">
                <div class="side-menu-btn"></div>
                <img class="side-menu-btn" src="images/side_menu_btn.png"/>
                <h3>成員</h3>
            </div>
            <div data-role="content">
	            <div class="main-user-area">
	               <div class="main-user-area-l"><img class="sm-user-pic" src="images/user_pic.png"/></div>
                   <div class="main-user-area-r"></div>
	            </div>
	            <div class="main-contact-l">
	               <div class="main-contact-l-content-area">
		               <div class="main-contact-l-row">全部聯絡人<img src="images/contact/contact_sidemenu_icon_arrow.png"/></div>
		               <div class="main-contact-l-row">我的最愛<img src="images/contact/contact_sidemenu_icon_arrow.png"/></div>
		               <div class="main-contact-l-row">總經理室<img src="images/contact/contact_sidemenu_icon_arrow.png"/></div>
		               <div class="main-contact-l-row">管理部<img src="images/contact/contact_sidemenu_icon_arrow.png"/></div>
		               <div class="main-contact-l-row">財會部<img src="images/contact/contact_sidemenu_icon_arrow.png"/></div>
	               </div>
	            </div>
	            <div class="main-contact-r">
	               <div class="main-contact-r-bar">
	                   <div class="main-contact-r-bar-l">群組</div>
	                   <div class="main-contact-r-bar-r">(可拖拉複製、移動群組)</div>
	                   <div class="main-count">0</div>
	               </div>
	               <div class="main-contact-r-group">
	                   <div class="main-contact-r-group-l"><img src="images/contact/contact_group_default_list_apt.png"></div>
	                   <div class="main-contact-r-group-r">策略行銷部</div>
	               </div>
	               <div class="main-contact-r-bar">
                       <div class="main-contact-r-bar-l">成員</div>
                       <div class="main-contact-r-bar-r">(可拖拉複製、移動群組)</div>
                       <div class="main-count">3</div>
                   </div>
                   <div class="main-contact-r-block">
                        <div class="main-contact-r-block-l"><img src="images/1.jpg"></div>
                        <div class="main-contact-r-block-r">
                            <div class="main-contact-r-block-r-1">孫協志</div>
                            <div class="main-contact-r-block-r-2">放假中，有事請手機聯絡</div>
                        </div>
                   </div>
                   <div class="main-contact-r-block">
                        <div class="main-contact-r-block-l"><img src="images/2.jpg"></div>
                        <div class="main-contact-r-block-r">
                            <div class="main-contact-r-block-r-1">王仁甫</div>
                            <div class="main-contact-r-block-r-2">放假中，有事請手機聯絡</div>
                        </div>
                   </div>
                   <div class="main-contact-r-block">
                        <div class="main-contact-r-block-l"><img src="images/3.jpg"></div>
                        <div class="main-contact-r-block-r">
                            <div class="main-contact-r-block-r-1">王紹偉</div>
                            <div class="main-contact-r-block-r-2">放假中，有事請手機聯絡</div>
                        </div>
                   </div>
                   <div class="main-contact-r-block">
                        <div class="main-contact-r-block-l"><img src="images/4.jpg"></div>
                        <div class="main-contact-r-block-r">
                            <div class="main-contact-r-block-r-1">許孟哲</div>
                            <div class="main-contact-r-block-r-2">放假中，有事請手機聯絡</div>
                        </div>
                   </div>
	            </div>
	            
	            <div class="main-footer">
	                <div data-main-act="event" class="main-footer-item"><img src="images/contact/toolbar_icon_event.png"/><div class="main-footer-desc">近期活動</div></div>
	                <div data-main-act="contact" class="main-footer-item"><img src="images/contact/toolbar_icon_contact.png"/><div class="main-footer-desc">聯絡人</div></div>
	                <div data-main-act="chat" class="main-footer-item"><img src="images/contact/toolbar_icon_chat.png"/><div class="main-footer-desc">聊天</div></div>
	                <div data-main-act="post" class="main-footer-item"><img src="images/contact/toolbar_icon_post.png"/><div class="main-footer-desc">公告</div></div>
	                <div class="main-footer-more"><img src="images/contact/toolbar_icon_more.png"/></div>
	                <div class="main-more-btn"></div>
	            </div><!-- /footer -->
	            <div class="main-footer-add">
                    <div data-main-act="noti" class="main-footer-item"><img src="images/contact/toolbar_icon_notification.png"/><div class="main-footer-desc">通報專區</div></div>
                    <div data-main-act="command" class="main-footer-item"><img src="images/contact/toolbar_icon_command.png"/><div class="main-footer-desc">命令</div></div>
                    <div data-main-act="calendar" class="main-footer-item"><img src="images/contact/toolbar_icon_calendar.png"/><div class="main-footer-desc">行事曆</div></div>
                    <div data-main-act="file" class="main-footer-item"><img src="images/contact/toolbar_icon_file.png"/><div class="main-footer-desc">檔案</div></div>
                    <div data-main-act="setting" class="main-footer-item"><img src="images/contact/toolbar_icon_setting.png"/><div class="main-footer-desc">團體設定</div></div>
                </div>
            </div>
            <div class="clear"></div>
        </div><!-- /page-group-main -->
        
		<div class="popup">
		  <div class="popup-frame">
		  <div class="popup-text"></div>
		  <a href="#" class="popup-close" data-role="button" data-inline="true">確定</a>
		  </div>
		  <div class="popup-screen"></div>
		</div>

        <div class="ui-loader ui-corner-all ui-body-a ui-loader-default"><span class="ui-icon ui-icon-loading"></span><h1>loading</h1></div>
        
        <div id="page-back-chk"></div>
        <div id="page-back-chk-pre"></div>
        
        <script type="text/javascript">
            $(function(){
            	//api 網址
                var base_url = "https://apserver.mitake.com.tw/apiv1/";
            	//ajax用
                var myRand = Math.floor((Math.random()*1000)+1);
                
                //全域
                var ui,at,gi,gn,gd,ga,gm,device_token;
                
                //計算螢幕長寬以維持比例
            	var proportion = 1.7;
            	$(".main").css("width",$(window).width());
            	$(".main").css("height",$(window).width()*proportion);
            	$(".main-contact-l").css("height",$(window).height()-186);
                $(window).resize(function(){ 
                	$(".main").css("width",$(window).width());
                	$(".main").css("height",$(window).width()*proportion);
                	$(".main-contact-l").css("height",$(window).height()-186);
                });
                
                $(".popup-screen").click(function(){
                    $(".popup").hide();
                    $(".popup-screen").hide();
                });
                
                $(".popup-close").click(function(){
                	$(".popup-screen").trigger("click");
                	$(".popup-close").trigger("pageChange");
                });
                
                $(document).ajaxSend(function() {
                	$('.ui-loader').css("display","block");
                });
                $(document).ajaxComplete(function() {
                	$('.ui-loader').hide();
                	$(document).trigger("click");
                });
                
                //上一頁機制
                $("#page-back-chk").html(window.location.hash);
                $(document).on("pagebeforeshow",function(){
                    $("#page-back-chk-pre").html($("#page-back-chk").html());
                    $("#page-back-chk").html(window.location.hash);
                });
                
                $(".page-back").click(function(){
                	$.mobile.changePage($("#page-back-chk-pre").html(), {transition: "slide",reverse: true});
                });
                
//----------------------------------- 登入 ---------------------------------------------
                //login打勾
                $(".login-radio").click(function(){
                    $(".login-radio img").toggle();
                });
                
                //login
                $("#login").click(function(){
                    //登入認證
                    var api_name = "login";
                    var headers = {
                        "pn":$("#phone").val(),
                        "up":toSha1Encode($("#code").val()), 
                        "gm":""
                    };
                    var method = "post";
                    var result = ajaxDo(api_name,headers,method,true);
                    result.complete(function(data){
                        if(data.status != 200){
                        	popupShowAdjust("帳號或密碼不對");
                        }else{
                        	ui = $.parseJSON(data.responseText).ui;
                            at = $.parseJSON(data.responseText).at;
                            //取得團體列表
                            console.log(ui);
                            console.log(at);
                            var api_name = "groups";
                            var headers = {
                                "ui":ui,
                                "at":at
                            };
                            var method = "get";
                            var result = ajaxDo(api_name,headers,method,true);
                            result.complete(function(data){
                                if(data.status != 200){
                                	$.mobile.changePage("#page-helper");
                                }else{
                                    $("#group-nav-area li a[data-group-act=gl]").trigger("click");
                                    $.mobile.changePage("#page-group-main", {transition: "pop"});
                                }
                            });
                        }
                    });
                });
//----------------------------------- 註冊 --------------------------------------------- 
                //register打勾
                $(".register-radio").click(function(){
                    $(".register-radio img").toggle();
                });

                //註冊頁面點選下一步 送出驗證碼
                $("#register-next").click(function(){
                	if(!$("#r-phone").val()){
                		popupShowAdjust("請輸入電話號碼");
                		return false;
                    }else if($(".register-radio img").css("display") == "none"){
                        popupShowAdjust("請勾選\"看過並同意使用條款及隱私政策\"");  
                        return false;
                    }else{
                    	$(".register-desc-area h1").html($("#r-phone").val());
                    	
                    	//亂數device token
                    	var chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";
					    var string_length = 8;
					    var randomstring = '';
					    for (var i=0; i<string_length; i++) {
					        var rnum = Math.floor(Math.random() * chars.length);
					        randomstring += chars.substring(rnum,rnum+1);
					    }
					    device_token = "web-" + randomstring;
					    //取得otp驗證碼
                    	var api_name = "register/otp";
                    	var headers = {
                    		"cc":"886",
							"pn":$("#r-phone").val(), 
							"di":device_token,
							"ug":"1"
                    	};
                    	var method = "get";
                    	var result = ajaxDo(api_name,headers,method,true);
                    	result.complete(function(data){
                    		if(data.status != 200){
                    			popupShowAdjust("電話號碼錯誤");
                    		}else{
                    			$.mobile.changePage("#page-register-auth");
                    		}
                    	});
                    	
                    }
                });
                
                //認證頁面點選下一步
                $("#register-auth-next").click(function(){
                    if(!$("#otp").val()){
                        popupShowAdjust("驗證碼輸入錯誤，請輸入正確的驗證碼。");                        
                        $(".resend-otp-close").hide();
                        $("#resend-otp").css("display","block");
                        return false;
                    }else{
                   	    //驗證otp
                        var api_name = "register/otp";
                        var headers = {
                            "cc":"886",
                            "pn":$("#r-phone").val(), 
                            "di":device_token,
                            "op":toSha1Encode($("#otp").val())
                        };
                        var method = "post";
                        //非同步
                        var result = ajaxDo(api_name,headers,method,true);
                        result.complete(function(data){
                            if(data.status != 200){
                            	$(".resend-otp-close").hide();
                                $("#resend-otp").css("display","block");
                                popupShowAdjust("驗證碼錯誤");
                            }else{
                            	ui = $.parseJSON(data.responseText).ui;
                                at = $.parseJSON(data.responseText).at;
                                $.mobile.changePage("#page-password");
                            }
                        });
                    }
                });
                
              //重送驗證碼
                $("#resend-otp").click(function(){
                	//取得otp驗證碼
                    var api_name = "register/otp";
                    var headers = {
                        "cc":"886",
                        "pn":$("#r-phone").val(), 
                        "di":device_token,
                        "ug":"1"
                    };
                    var method = "get";
                    ajaxDo(api_name,headers,method,true);
                    popupShowAdjust("驗證碼已送出。");
                    $("#resend-otp").css("display","none");
                });

                //密碼設定
                $("#pw-send").click(function(){
                    if(($("#pw-setting").val() != $("#pw-setting-c").val()) || $("#pw-setting").val().length < 6){
                    	popupShowAdjust();
                        return false;
                    }else{
                    	var api_name = "me/password";
                        var headers = {
                            "ui":ui, 
							"at":at, 
							"up":toSha1Encode($("#pw-setting").val()),
							"pn":$("#r-phone").val(), 
							"gm":"", 
							"op":toSha1Encode($("#otp").val())
                        };
                        var method = "put";
                        //非同步 才能取值
                        var result = ajaxDo(api_name,headers,method,true);
                        result.complete(function(data){
                            if(data.status != 200){
                                popupShowAdjust("密碼輸入錯誤。");
                            }else{
                            	popupShowAdjust("密碼變更完成。");
                                popupAfterChangePage("#page-helper");
                            }
                        });
                    }
                });
//----------------------------------- 團體選單 ---------------------------------------------                
                //團體選單 點選團體
                $(document).on('click','.group-list-box',function(e){
		            $.mobile.changePage("#page-group-main");
		        });
                
                //團體選單 點選nav
                $("#group-nav-area li a").click(function(){
                    var act = $(this).data("group-act");
                    $(".group-nav-chk").each(function(i,val){
                        if($(this).data("group-act") == act){
                            $(this).fadeIn();
                            //個別的動作
                            switch (act) {
	                            case "gl": 
	                                groupMenuListArea(ui,at);
	                              break;
	                            case "gc": 
	                                $(".group-create-area").find("input").val("");
	                                $(".group-create-area").find("textarea").val("");
	                              break;
	                            case "gj":
	                              break;
	                            case "gi":
	                              break;
	                        }
                        }else{
                            $(this).hide();
                        }
                    });
                });
                
                //創建團體 建立
                $("#gm-create-submit").click(function(){
                	if(!$("#group-name").val()){
                        popupShowAdjust("團體名稱不可空白");
                        return false;
                	}else{
                		var api_name = "groups";
                        var headers = {
                            "ui":ui,
                            "at":at,
                            "li":"zh_TW",
                            "gn":encodeURI($("#group-name").val()),
                            "gd":encodeURI($("#group-desc").val())
                        };
                        var method = "post";
                        var result = ajaxDo(api_name,headers,method,true);
                        result.complete(function(data){
                            if(data.status = 200){
                            	console.log("a");
                            	console.log($(".popup-frame").width());
                            	popupShowAdjust("創建成功。");
                                popupAfterChangePage("#page-group-main");
                            }else{
                            	popupShowAdjust("未知錯誤。");
                                return false;;
                            }
                        });
                	}
                });
//----------------------------------- 小幫手 ---------------------------------------------
                //小幫手 創建團體
                $(".hg-create").click(function(){
                	$("#group-nav-area li a[data-group-act=gc]").trigger("click");
                	$("#group-nav-area li a[data-group-act=gc]").addClass("ui-btn-active");
                	$.mobile.changePage("#page-group-menu");
                });
                //小幫手 加入團體
                $(".hg-join").click(function(){
                	$("#group-nav-area li a[data-group-act=gj]").trigger("click");
                	$("#group-nav-area li a[data-group-act=gj]").addClass("ui-btn-active");
                });
              //小幫手 邀請團體  側邊選單
                $(".hg-invited").click(function(){
                    $("#group-nav-area li a[data-group-act=gi]").trigger("click");
                    $("#group-nav-area li a[data-group-act=gi]").addClass("ui-btn-active");
                    $.mobile.changePage("#page-group-menu");
                });

//----------------------------------- 左側選單 ---------------------------------------------
				$(".side-menu-btn").click(function(){
                    $( "#side-menu" ).panel( "open");
                });
                
                //用戶區
                //detect page changing
		        $("#side-menu").on("panelbeforeopen",function(){
		                //取得個人圖像
		                $(".sm-user-area-l").html("<img class=\"sm-user-pic\" src=\"images/user_pic.png\"/>");
		                //計數
		                $("div[data-sm-act=feed] .sm-count").show();
		                
		                //取得個人資料
		            	var api_name = "auth";
                        var headers = {
                            "ui":ui,
                            "at":at
                        };
                        var method = "put";
                        ajaxDo(api_name,headers,method,true).complete(function(data){
                        	var nk = $.parseJSON(data.responseText).nk;
                            var sl = $.parseJSON(data.responseText).sl;
                            
                            $(".sm-user-area-r").html(nk + "<br/>" + sl);
                            $(".sm-group-area .sm-count").show();
                        });
                        
                        //團體列表
                        groupMenuListArea(ui,at);
		        });

		        //開關團體列表
                $(".sm-group-switch").click(function(){
                	$(".sm-switch-ui-adj").removeClass("sm-switch-ui-adj-show");
                	$(".sm-group-list-area-add").slideToggle(
               			function(){
               				if($(".sm-group-list-area-add").is(":visible")){
               					$(".sm-group-switch").find("img").attr("src","images/side_menu/sidemenu_slidedown_icon_click.png");
               				}else{
               					$(".sm-group-switch").find("img").attr("src","images/side_menu/sidemenu_slidedown_icon_none.png");	
               				}
               			}
               		);
                });
		        
                //按鈕效果
                $(document).on("mousedown",".sm-small-area,.sm-group-area,.sm-group-cj-btn",function(){
		        	var icon_default = "images/side_menu/sidemenu_icon_";
		        	var target = $(this);
		        	
		        	//開關按鈕ui變化
		        	if($(".sm-group-list-area-add").is(":visible") ){
		        		if(target.data("switch-chk") == "check2"){
		        			$(".sm-switch-ui-adj").addClass("sm-switch-ui-adj-show");
		        		}
                    }else{
                    	if(target.data("switch-chk") == "check"){
                            $(".sm-switch-ui-adj").addClass("sm-switch-ui-adj-show");
                        }
                    }
		        	
		        	target.addClass("sm-click-bg");
		        	target.find(".sm-small-area-l img").attr("src",icon_default + target.data("sm-act") + "_click.png");
		        	/* console.log(target.data("sm-act"));
		        	switch (target.data("sm-act")) {
	                    case "feed":
	                    	target.find(".sm-small-area-l img").attr("src",icon_default + target.data("sm-act") + "_click.png");
	                      break;
	                    case "contact": 
	                      break;
	                    case "chat":
	                      break;
	                    case "calendar":
	                      break;
	                    case "help":
                          break;
                        case "news":
                          break;
                        case "setting":
                          break;
	                } */
		        });
                //按鈕效果
                $(document).on("mouseup",".sm-small-area,.sm-group-area,.sm-group-cj-btn",function(){
		        	var icon_default = "images/side_menu/sidemenu_icon_";
		        	var target = $(this);
                    setTimeout(function(){
                    	//開關按鈕ui變化
                    	if($(".sm-group-list-area-add").is(":visible") ){
                            if(target.data("switch-chk") == "check2"){
                                $(".sm-switch-ui-adj").removeClass("sm-switch-ui-adj-show");
                            }
                        }else{
                            if(target.data("switch-chk") == "check"){
                                $(".sm-switch-ui-adj").removeClass("sm-switch-ui-adj-show");
                            }
                        }
                    	target.removeClass("sm-click-bg");
                    	target.find(".sm-small-area-l img").attr("src",icon_default + target.data("sm-act") + ".png");
                    	},1000);
                    
                    
                });
                
                //功能選單
                $(".main-more-btn").click(function(){
                	var target = $(".main-footer-add");
                	if(target.css("bottom") == "125px"){
                		$(".main-footer-add").animate({bottom:"194px"},function(){
                			$(".main-footer").css("z-index","0");
                		});	
                	}else{
                		$(".main-footer").css("z-index","100");
                		$(".main-footer-add").animate({bottom:"125px"});
                	}
                });
                
                
                
//----------------------------------- function ---------------------------------------------                
                //ajax
                function ajaxDo(api_name,headers,method,async){
                    //console.log(api_url);
                    var api_url = base_url + api_name;
                    var myRand = Math.floor((Math.random()*1000)+1);
                    
                    if(async){
                    	var result = $.ajax ({
                            url: api_url,
                            type: method,
                            headers:headers,
                        });/* ajax結束 */
                    }else{
                    	var result = $.ajax ({
                            url: api_url,
                            type: method,
                            headers:headers,
                            async:false,
                        });/* ajax結束 */
                    }
                    
                    return result;
                }
                
                function groupMenuListArea(ui,at){
                    
                    var api_name = "groups";
                    var headers = {
                        "ui":ui,
                        "at":at
                    };
                    var method = "get";
                    result = ajaxDo(api_name,headers,method);
                    console.log(result);
                    if(result.responseText){
                    	$(".sm-group-list-area").html("");
                    	$(".sm-group-list-area-add").html("");
                    	//chk是開關按鈕ui變化的檢查
                    	var tmp_selector,count,chk;
                    	var group_list = $.parseJSON(result.responseText).gl;
                    	var total = group_list.length;
                        $.each(group_list,function(i,val){
                        	if(i < 2){
                        		tmp_selector = ".sm-group-list-area";
                        	}else{
                        		tmp_selector = ".sm-group-list-area-add";
                        	}
                        	
                        	//開關按鈕ui變化
                            if(i == 1 || total == 1){
                                chk = "data-switch-chk=\"check\"";
                            }
                            if(i == total-1 ){
                                chk = "data-switch-chk=\"check2\"";
                            }
                        	
                            $(tmp_selector).append(
                           		'<div class="sm-group-area" ' + chk + '>' +
                           	        '<div data-gi="' + decodeURI(val.gi) + '" class="sm-group-area-l">' +
                           	            '<img src="images/no_pic_g.png">' +
                           	        '</div>' +
                           	        '<div class="sm-group-area-r">' + decodeURI(val.gn) + '</div>' +
                           	        '<div class="sm-count">20</div>' +
                           	    '</div>'
                     	    );
                        });
                        if(group_list.length > 2){
                        	$(".sm-group-switch").show();
                        }
                    }
                }
              //計算彈出對話框置中
                function popupShowAdjust(desc){
                	$(".popup-frame").css("margin-left",0);
                    if(desc){
                        $('.popup-text').html(desc);
                    }
                    $(".popup-screen").show();
                    $(".popup").show();
                    $(".popup-frame").css("margin-left",($(document).width() - $(".popup-frame").width())/2-15);
                }
		        
                function popupAfterChangePage(dest){
                	$(".popup-close").bind("pageChange",function(){
                		$.mobile.changePage(dest);
                		$(".popup-close").unbind("pageChange");
                	});
                }
                
                //sha1 and base64 encode
                function toSha1Encode(string){
                	var hash = CryptoJS.SHA1(string);
                    var toBase64 = hash.toString(CryptoJS.enc.Base64);
                    return toBase64;
                }
            });
        </script>
    </body>
</html>