<!DOCTYPE html>
<html>
  <head>
    <title>O REST client</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="images/rs.png">
    <!-- Css -->
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/bootstrap-select.min.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
    
    <!-- JavaScript -->
    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/bootstrap-select.min.js"></script>
    
    <!-- setting -->
    <script src="js/setting.js"></script>
    
  </head>
  <body>
    <div class="main">
	  <h3><a href="http://youtu.be/2Ii0kpKi8kI" target="_blank"><img src="images/rs.png"/></a>  Project O REST client</h3>
	  <section>
	      <form id="request"><fieldset>
		        <legend>request</legend>  
		        
		        <!------ request ---------------------------------------------------------------->
		        <div class="row">
			        <div class="col-md-12">
	                    <select class="selectpicker">
	                        <option value="" disabled selected>請選擇 api</option>
						    <option value="1">1. 系統-檢查版本</option>
							<option value="2">2. 註冊-取得OPT驗證碼</option>
							<option value="3">3. 註冊-OPT驗證</option>
							<option value="4">4. 使用者-設定密碼</option>
							<option value="5">5. 使用者-上傳頭像</option>
							<option value="6-1">6-1. 使用者-下載自己頭像</option>
							<option value="6-2">6-2. 使用者-下載別人頭像</option>
							<option value="7">7. 使用者-登入</option>
							<option value="8">8. 使用者-驗證 </option>
							<option value="9">9. 使用者-登出</option>
							<option value="10">10. 團體-建立新團體</option>
							<option value="11">11. 團體-上傳團體頭像</option>
							<option value="12">12. 團體-下載團體頭像</option>
							<option value="13">13. 團體-邀請朋友入團</option>
							<option value="14">14. 團體-參加團體</option>
							<option value="15">15. 團體-參與團體的列表</option>
							<option value="16">16. 系統-輪詢機制</option>
							<option value="17">17. 系統-選單列表</option>
							<option value="18">18. 使用者-更新座標與推撥Token</option>
							<option value="19">19. 使用者-通知中心列表</option>
					    </select>
				    </div>
                </div>
                <div class="row">
	                <div class="col-md-1">
	                    <span class="text-control">URL</span>
	                </div>
	                <div class="col-md-11">
	                    <input id="input-url" type="text" class="form-control">
	                </div>
                </div>
                <div class="row">
                    <div class="col-md-1">
                        <span class="text-control">Method</span>
                    </div>
                    <div class="col-md-11">
                        <input id="get" name="method" class="radio-control" type="radio"><label for="get"> GET</label>
                        <input id="post" name="method" class="radio-control" type="radio"><label for="post"> POST</label>
                        <input id="put" name="method" class="radio-control" type="radio"><label for="put"> PUT</label>
                        <input id="delete" name="method" class="radio-control" type="radio"><label for="delete"> DELETE</label>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-1">
                        <span class="text-control">Header</span>
                    </div>
                    <div class="col-md-7">
                        <textarea class="textarea-control"></textarea>
                    </div>
                    <div class="col-md-4">
                        <div class="params-desc"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-1">
                    </div>
                    <div class="col-md-11">
                        <button id="clear" type="button" class="btn btn-primary">Clear</button>
						<button id="send" type="button" class="btn btn-primary ">Send</button>
                    </div>
                    
                </div>
				<div class="row">
                    <div class="col-md-1">
                        <span class="text-control">Status</span>
                    </div>
                    <div class="col-md-11">
                        <input id="input-status" type="text" class="form-control">
                    </div>
                </div>    
	         <!------------------------------------------------------------------------------------->
	      </fieldset></form>
    </section>
    <section>
        <div class="row">
            <div class="col-md-6">
                <fieldset id="response">
                    <legend>response</legend> 
                    <textarea class="r-textarea-control"></textarea>
                </fieldset>
            </div>
            <div class="col-md-6">
                <fieldset>
                    <legend>response desc</legend> 
                    <textarea class="r-textarea-control"></textarea>
                </fieldset>
            </div>
        </div>  
    </section>
	</div>
	
    <script type="text/javascript">
        $(window).on('load', function () {
        	
        	//全域data.json變數
        	var apiObj;
        	var post_url = 'api.php';
            //啓動選單樣式
            $('.selectpicker').selectpicker();
            //清除選單內容
            $('#clear').click(function(){
            	$('.params-desc').html('');
            	$('.r-textarea-control').val('');
            	if($('form fieldset .row:eq(4)').find('span').html() == 'Body'){
                    $('form fieldset .row:eq(4)').remove();
            	}
            	$("#request")[0].reset();
            });
            //點選送出
            $('#send').click(function(){
            	/* 解header內容 
            	var textarea_str = $(".textarea-control:eq(0)").val(); 
            	var headers = textarea_str.split(/\n/gi);
            	var nheaders = new Array;
            	$.each(headers,function(i,val){
            		var temp = val.split(/ /gi);
            		var param = temp[0].substr(0, temp[0].length-1);  
            		nheaders[param] = temp[1];
            	}) */
            	
            	
            	//response desc
		        /* var status = apiObj.status["200"];
		        if($.type( status ) == "object"){
		        	var desc;
		        	$.each(status,function(i,val){
                        if(desc == null){
                        	desc = i + ': ' + params_arr[i] + '\n';
                        }else{
                        	desc += i + ': ' + params_arr[i] + '\n';
                        }
                    })
                    
                    $('.r-textarea-control:eq(1)').val(desc);
		        }
		        //response
            	$('.r-textarea-control:eq(0)').val(JSON.stringify(apiObj.status, null, 2)); */
            	$('.r-textarea-control').val('');
            	
            	var body = "";
            	if($('.textarea-control:eq(1)').html()){
            		body = $('.textarea-control:eq(1)').html();
            	}
            	
            	$.post (post_url,{api_url:$('#input-url').val(),headers:$(".textarea-control:eq(0)").val(),method:$('input[name=method]:checked').attr('id'),body:body},function(result){
            		console.log(result);
            		var obj = $.parseJSON(result);
            		var status = obj.status;
            		var desc = '';
            		var status_desc = '';
            		var status_sub_desc = '尚未說明';
            		if(status != 200){
            			if(apiObj.status[status]){
            				status_sub_desc = apiObj.status[status];
            			}
            			status_desc = status + ' : ' + status_sub_desc + '\n';
            		}
            		
            		$('#input-status').val(status);
            		
            		//response
                    if($.type( obj.result ) == "object"){
                    	$('.r-textarea-control:eq(0)').val(JSON.stringify(obj.result, null, 2));
                    	//response desc
                        $.each(obj.result,function(i,val){
                        	var params = params_arr[i];
                        	if(!params_arr[i]){
                        		params = "尚未說明";
                        	}
                        	
                            if(desc == null){
                                desc = i + ': ' + params + '\n';
                            }else{
                                desc += i + ': ' + params + '\n';
                            }
                        })
                        
                        
                    }else{
                    	$('.r-textarea-control:eq(0)').val(obj.result);
                    }
            		
                    $('.r-textarea-control:eq(1)').val(status_desc + desc);
                }); 
            });

            //選單選擇
            $('fieldset select').change(function () {
            	$('.r-textarea-control').val('');
            	$('#input-status').val('');
            	$('.params-desc').html('');
            	var method = "get";
            	
            	 $.getJSON("data.json", function(json) {
					var api_num = $('#request select').val();
					var method = json[api_num].method;
					var header = json[api_num].header;
					var fake_header = json[api_num].fake_header;
					var header_str;
					var colon = ':';
					apiObj = json[api_num];
					console.log(apiObj);
					//製作縮寫說明
					//另外存header 因應假資料...
					var header_params = new Array;
                    $.each(header,function(i,val){
                        header_params[i] = val;
                    });
                        
					if(fake_header){
						header = fake_header;
						colon = '';
					}
					$.each(header,function(i,val){
						$('.params-desc').append(
							'<div class="input-group">' +
							'<span class="input-group-addon">' + header_params[i] + '</span>' +
							'<input type="text" class="form-control" value="' + params_arr[header_params[i]] + '">' +
							'</div>'
						);
						if(i == 0){
							header_str = val + colon +' \n';
						}else{
							header_str += val + colon +' \n';
						}
					})
					//header內容
					$('.textarea-control').val(header_str);
					//api有body參數
					if(apiObj.body){
						//body textarea存在的話就清空
						if($('form fieldset .row:eq(4)').find('span').html() == 'Body'){
                            $('form fieldset .row:eq(4)').remove();
                        }
						//body 為true但不是json 的話清空
						var body = JSON.stringify(apiObj.body, null, 2);
						if(body == "true"){
							body = "";
						}
						//填入body內容
	                    $('form fieldset .row:eq(3)').after(
	                    	'<div class="row">' +
	                            '<div class="col-md-1">' +
	                                '<span class="text-control">Body</span>' +
	                            '</div>' +
	                            '<div class="col-md-7">' +
	                                '<textarea class="textarea-control">' + body + '</textarea>' +
	                            '</div>' +
	                            '<div class="col-md-4">' +
	                            '</div>' +
	                        '</div>'
	                    );
						
	                    /*//製作body參數說明
	                    var status = apiObj.status["200"];
	                    if($.type( status ) == "object"){
	                        var desc;
	                         "body":{
					             "ul":
					              [
					                {
					                 "gt":"", 
					                 "gp": "",
					                 "cc":"+886",
					                 "pn":"936123456",
					                 "em":"aaa@test.com",
					                 "nk": "王小明"
					                }
					              ]
					        } 
	                        $.each(status,function(i,val){
	                        	$('.params-desc').append(
                                    '<div class="input-group">' +
                                    '<span class="input-group-addon">' + val + '</span>' +
                                    '<input type="text" class="form-control" value="' + params_arr[val] + '">' +
                                    '</div>'
                                );
	                        })
	                        
	                        $('.r-textarea-control:eq(1)').val(desc);
	                    } */
					}else{
						if($('form fieldset .row:eq(4)').find('span').html() == 'Body'){
		                    $('form fieldset .row:eq(4)').remove();
		                }
					}
					
					$("#"+method).trigger('click');
					$('#input-url').val(api_url + json[api_num].url);
            	});
            	
            });
        });
    </script>
    
  </body>
</html>

